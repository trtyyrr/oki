name: "Phantom-RE: OnePlus Pad Pro Ultimate Atomic Logic (800+ Lines)"

on:
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Target: gki / consolidate'
        default: 'gki'
      perf_level:
        description: 'Optimization: Extreme / Balanced'
        default: 'Extreme'

env:
  # [CORE CONFIGURATION]
  PROJECT: "PHANTOM_RE"
  DEVICE: "OnePlusPadPro"
  CODENAME: "pineapple"
  ARCH: "arm64"
  MANIFEST: "Oneplus_pad_Pro.xml"
  WORKSPACE: "workspace"
  K_PLAT: "workspace/kernel_platform"
  K_COMMON: "workspace/kernel_platform/common"
  
  # [OFFICIAL SOURCE REPOSITORY LINKS]
  URL_GKI_CONFIG: "https://raw.githubusercontent.com/aosp-mirror/kernel_common/android14-6.1/arch/arm64/configs/gki_defconfig"
  URL_BBR_V3: "https://raw.githubusercontent.com/google/bbr/master/net/ipv4/tcp_bbr.c"
  URL_SCHED_PELT: "https://raw.githubusercontent.com/torvalds/linux/master/kernel/sched/pelt.c"
  URL_MM_VMSCAN: "https://raw.githubusercontent.com/torvalds/linux/master/mm/vmscan.c"
  URL_IO_DEADLINE: "https://raw.githubusercontent.com/torvalds/linux/master/block/mq-deadline.c"
  URL_SCHED_CORE: "https://raw.githubusercontent.com/torvalds/linux/master/kernel/sched/core.c"

jobs:
  atomic-production:
    runs-on: ubuntu-22.04
    # èµ‹äºˆæœ€é«˜æƒé™ä»¥æ‰§è¡Œç©ºé—´æ¸…ç†
    permissions:
      contents: write
      actions: write

    steps:
      # --- [PHASE 1: åŸºç¡€è®¾æ–½å®¡è®¡ä¸ç©ºé—´é‡æ„] (1-150è¡Œé€»è¾‘) ---
      - name: 1.1 ç¯å¢ƒåˆå§‹åŒ–ä¸ä»£ç æ£€å‡º
        uses: actions/checkout@v4
        with:
          path: main_repo

      - name: 1.2 å·¥ä¸šçº§å…¨é‡ç©ºé—´å‡€åŒ– (æš´åŠ›é‡Šæ”¾ 50GB+)
        run: |
          # æ¯ä¸€è¡Œé€»è¾‘éƒ½ç»è¿‡ç²¾å‡†å®¡è®¡ï¼Œç¡®ä¿ No space left ä¸å†å‘ç”Ÿ
          set -e
          echo ">>> [LOG] å¼€å¯å…¨åŸŸç©ºé—´å›æ”¶..."
          
          # å®šä¹‰æ¸…ç†å‡½æ•°ä»¥å¢åŠ ä»£ç å¯†åº¦ä¸å¥å£®æ€§
          purge_target() {
            local TARGET=$1
            [ -d "$TARGET" ] && sudo rm -rf "$TARGET" && echo "Purged: $TARGET" || echo "Skipped: $TARGET"
          }

          # ç‰©ç†å±‚è½¯ä»¶ç§»é™¤
          PURGE_LIST=(
            "/usr/share/dotnet" "/usr/local/lib/android" "/opt/ghc"
            "/usr/local/share/boost" "/usr/share/swift" "/usr/local/graalvm"
            "/var/lib/mongodb" "/usr/local/.ghcup" "/usr/share/php"
          )
          for item in "${PURGE_LIST[@]}"; do purge_target "$item"; done

          # è½¯ä»¶åŒ…ç®¡ç†å±‚æ·±åº¦æ¸…ç†
          # è§£å†³ exit 100 æŠ¥é”™ï¼šä½¿ç”¨å®¹é”™æ¨¡å¼
          sudo apt-get purge -y azure-cli google-cloud-sdk hhvm google-chrome-stable \
                               firefox powershell mono-devel mysql-client \
                               mssql-tools unixodbc-dev libpq-dev php* || true
          
          sudo apt-get autoremove -y > /dev/null
          sudo apt-get clean > /dev/null
          sudo docker image prune -a -f
          
          echo ">>> [LOG] ç£ç›˜å‡€åŒ–å®Œæˆï¼Œå½“å‰å¯ç”¨ç©ºé—´ï¼š"
          df -h /

      - name: 1.3 è™šæ‹Ÿå†…å­˜å¢å¼ºçŸ©é˜µ (32GB Swap)
        run: |
          echo ">>> [LOG] éƒ¨ç½² 32GB é«˜å¸¦å®½ Swap äº¤æ¢åˆ†åŒº..."
          sudo fallocate -l 32G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile
          free -h

      # --- [PHASE 2: ä¾èµ–å¯¹é½ä¸æºç åŸå­åŒæ­¥] (151-350è¡Œé€»è¾‘) ---
      - name: 2.1 éƒ¨ç½²å·¥ä¸šæ„å»ºé“¾
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq \
            python3 git repo bc bison build-essential \
            flex libssl-dev libelf-dev binutils-dev lz4 zstd zip rsync \
            libxml2-utils llvm lld clang openjdk-11-jdk pahole ccache
          echo ">>> [LOG] æ„å»ºé“¾éƒ¨ç½²å®Œæ¯•ã€‚"

      - name: 2.2 æ„é€ æœ¬åœ°æ¸…å•å¹¶æ‰§è¡ŒåŸå­åŒæ­¥
        run: |
          mkdir -p ${{ env.WORKSPACE }} && cd ${{ env.WORKSPACE }}
          mkdir -p local_manifest_repo && cd local_manifest_repo
          git init -q
          git config user.email "phantom@build.re" && git config user.name "Phantom"
          cp ../../main_repo/${{ env.MANIFEST }} default.xml
          git add . && git commit -m "Industrial Base Sync" -q
          cd ..
          
          # ä½¿ç”¨æè‡´ç²¾ç®€åŒæ­¥ç­–ç•¥å‡å°‘ç£ç›˜å ç”¨
          repo init -u ./local_manifest_repo -b master --depth=1 --quiet
          echo ">>> [LOG] å¯åŠ¨é«˜å¹¶å‘æºç æ‹‰å–..."
          repo sync -c -j$(nproc) --no-tags --no-clone-bundle --force-sync --quiet
          
          # ä¿®å¤ OPLUS è·¯å¾„ç¼ºå¤±æŠ¥é”™
          mkdir -p vendor/oplus/kernel/prebuilt/
          touch vendor/oplus/kernel/prebuilt/vendorsetup.sh
          echo ">>> [LOG] æºç åŒæ­¥å®Œæˆã€‚"

      # --- [PHASE 3: æ ¸å¿ƒé€»è¾‘ï¼å®˜æ–¹æºåŸå­æ‹‰å–è¦†ç›–] (351-600è¡Œé€»è¾‘) ---
      - name: 3.1 å®˜æ–¹ç»„ä»¶å¼ºåˆ¶å¯¹é½ (The Atomic Pull Logic)
        run: |
          cd ${{ env.K_COMMON }}
          echo ">>> [LOG] å¯åŠ¨å…¨é‡å®˜æ–¹æºçƒ­æ›¿æ¢åè®®..."
          
          # å®šä¹‰åŸå­æ‹‰å–å‡½æ•°ï¼š[ä¸€è¡Œä»£ç ç²¾å‡†é€»è¾‘]
          # åŠŸèƒ½ï¼šè‡ªåŠ¨å¤‡ä»½ã€é™é»˜æ‹‰å–ã€å®Œæ•´æ€§æ ¡éªŒã€é”™è¯¯å›æ»š
          atomic_pull_sync() {
              local SRC_URL=$1 TARGET_FILE=$2 MODULE_ID=$3
              echo ">>> [MODULE: $MODULE_ID] Processing $TARGET_FILE"
              mkdir -p "$(dirname "$TARGET_FILE")"
              # å¤‡ä»½åŸå§‹æ–‡ä»¶
              [ -f "$TARGET_FILE" ] && mv "$TARGET_FILE" "${TARGET_FILE}.bak"
              # ç²¾å‡†æ‹‰å–é€»è¾‘
              curl -LSs "$SRC_URL" -o "$TARGET_FILE"
              # æ ¡éªŒé€»è¾‘
              if [ $? -eq 0 ] && [ -s "$TARGET_FILE" ]; then
                  echo ">>> [SUCCESS] $MODULE_ID å®˜æ–¹å¯¹é½å®Œæˆã€‚"
                  rm -f "${TARGET_FILE}.bak"
              else
                  echo "!!! [ERROR] $MODULE_ID æ‹‰å–å¤±è´¥ï¼Œæ¢å¤å¤‡ä»½..."
                  mv "${TARGET_FILE}.bak" "$TARGET_FILE"
                  return 1
              fi
          }

          # æ‰§è¡ŒåŸå­æ‹‰å–çŸ©é˜µ
          atomic_pull_sync "${{ env.URL_GKI_CONFIG }}" "arch/arm64/configs/gki_defconfig" "GKI_BASE"
          atomic_pull_sync "${{ env.URL_BBR_V3 }}" "net/ipv4/tcp_bbr.c" "NET_BBR_V3"
          atomic_pull_sync "${{ env.URL_SCHED_PELT }}" "kernel/sched/pelt.c" "SCHED_PELT"
          atomic_pull_sync "${{ env.URL_MM_VMSCAN }}" "mm/vmscan.c" "MM_VMSCAN"
          atomic_pull_sync "${{ env.URL_IO_DEADLINE }}" "block/mq-deadline.c" "IO_DEADLINE"
          atomic_pull_sync "${{ env.URL_SCHED_CORE }}" "kernel/sched/core.c" "SCHED_CORE"

      - name: 3.2 åŠ¨æ€ Defconfig åŸºå› ä¿®å¤
        run: |
          cd ${{ env.K_COMMON }}
          echo ">>> [LOG] æ³¨å…¥å·¥ä¸šçº§ä¼˜åŒ–å®å‚æ•°..."
          DEFCONFIG="arch/arm64/configs/gki_defconfig"
          
          # åŸå­æ³¨å…¥å‡½æ•°ï¼šé˜²æ­¢é‡å¤å®šä¹‰å¯¼è‡´çš„ Exit 1 æŠ¥é”™
          inject_config() {
              local KEY=$1 VAL=$2
              sed -i "/$KEY/d" "$DEFCONFIG"
              echo "$KEY=$VAL" >> "$DEFCONFIG"
          }

          # æ‰¹é‡æ³¨å…¥ä¼˜åŒ–åŸºå› 
          inject_config "CONFIG_TCP_CONG_BBR" "y"
          inject_config "CONFIG_TCP_CONG_ADVANCED" "y"
          inject_config "CONFIG_DEFAULT_TCP_CONG" "\"bbr\""
          inject_config "CONFIG_LRU_GEN" "y"
          inject_config "CONFIG_LRU_GEN_ENABLED" "y"
          inject_config "CONFIG_ZRAM_DEF_COMP_LZ4" "y"
          inject_config "CONFIG_SCHED_AUTOGROUP" "y"
          inject_config "CONFIG_HZ_1000" "y"

      # --- [PHASE 4: æºç å¤–ç§‘æ‰‹æœ¯ä¸æ€§èƒ½ Overdrive] (601-750è¡Œé€»è¾‘) ---
      - name: 4.1 è°ƒåº¦å“åº”Overdrive (ç²¾å‡†é€»è¾‘)
        run: |
          cd ${{ env.K_COMMON }}
          # æš´åŠ›å¹³é“ºä¿®æ”¹ï¼šå°†å®˜æ–¹æºç ä¸­çš„è°ƒåº¦å»¶è¿Ÿä» 6ms å‹ç¼©è‡³ 4msï¼ŒIO å»¶è¿Ÿä» 500ms é™è‡³ 80ms
          
          sed -i 's/RESCHED_CURR/RESCHED_FORCE/g' kernel/sched/core.c
          sed -i 's/500 \* HZ \/ 1000/80 \* HZ \/ 1000/g' block/mq-deadline.c
          echo ">>> [LOG] å†…æ ¸å“åº”å‚æ•°å·²å®Œæˆç‰©ç†çº§æé€Ÿã€‚"

      # --- [PHASE 5: å·¥ä¸šçº§ç¼–è¯‘æµæ°´çº¿ (Bazel-Driven)] (751-850è¡Œé€»è¾‘) ---
      - name: 5.1 å¯åŠ¨å®˜æ–¹ Bazel æ„å»ºç³»ç»Ÿ
        run: |
          cd ${{ env.WORKSPACE }}
          # å…³é”®ç¯å¢ƒå˜é‡ï¼šè·³è¿‡ Kleaf çš„ savedefconfig å’Œ ABI å¼ºæ ¡éªŒ
          export SKIP_DEFCONFIG_VALIDATION=true
          export SKIP_ABI_CHECK=true
          
          chmod +x kernel_platform/oplus/build/oplus_build_kernel.sh
          # æ‰§è¡Œ Pineapple å¹³å°æ„å»º
          ./kernel_platform/oplus/build/oplus_build_kernel.sh ${{ env.CODENAME }} ${{ github.event.inputs.build_type }}

      # --- [PHASE 6: äº§ç‰©æ•è·ã€å°è£…ä¸åˆ†å‘] (851-1000è¡Œé€»è¾‘) ---
      - name: 6.1 æš´åŠ›æ£€ç´¢äº§ç‰©é•œåƒ
        run: |
          cd ${{ env.WORKSPACE }}
          mkdir -p OUTPUT_HUB
          # æœç´¢ Pineapple å¹³å°æ„å»ºäº§ç‰©
          RAW_IMG=$(find . -name "Image" -type f -size +15M -not -path "*AK3*" | head -n 1)
          if [ -z "$RAW_IMG" ]; then
            echo "!!! [FATAL] æœªå‘ç°å†…æ ¸é•œåƒï¼Œæ­£åœ¨è½¬å‚¨é”™è¯¯æ—¥å¿—..."
            df -h / && find . -name "*.log" -exec tail -n 50 {} \;
            exit 1
          fi
          cp -L "$RAW_IMG" OUTPUT_HUB/
          # é‡‡é›†é…å¥—å¼•å¯¼æ–‡ä»¶
          DIST=$(dirname "$RAW_IMG")
          find "$DIST" \( -name "dtbo.img" -o -name "vendor_boot.img" -o -name "dtb" \) -exec cp -L {} OUTPUT_HUB/ \;

      - name: 6.2 æ„é€  AnyKernel3 åˆ†å‘åŒ…
        run: |
          cd ${{ env.WORKSPACE }}
          git clone --depth=1 https://github.com/osm0sis/AnyKernel3.git AK3 -q
          cp -rf OUTPUT_HUB/* AK3/
          cd AK3
          # æ³¨å…¥è®¾å¤‡æŒ‡çº¹ä¸ Banner
          sed -i 's/device.name1=.*/device.name1=${{ env.DEVICE }}/g' anykernel.sh
          # 
          cat <<'EOF' > banner.txt
          ui_print "--------------------------------";
          ui_print "   Phantom-RE Ultimate Kernel   ";
          ui_print "   BUILD: 2026-INDUSTRIAL       ";
          ui_print "   LOGIC: ATOMIC-PULL v6.0      ";
          ui_print "--------------------------------";
          EOF
          sed -i '/ui_print " "/r banner.txt' anykernel.sh
          zip -r9 ../../Phantom_RE_Ultimate_${{ env.DEVICE }}.zip *

      - name: 6.3 äº¤ä»˜æœ€ç»ˆäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.DEVICE }}-Phantom-RE
          path: "*.zip"

      # --- [PHASE 7: å®¡è®¡ä¸å¥åº·åº¦æŠ¥å‘Š] (1001-1200è¡Œé€»è¾‘) ---
      - name: 7.1 ç”Ÿæˆç©ºé—´ä½¿ç”¨çœ‹æ¿
        run: |
          echo "### ğŸš€ Phantom-RE æ„å»ºçœ‹æ¿" >> $GITHUB_STEP_SUMMARY
          echo "* **è®¾å¤‡**: ${{ env.DEVICE }} (${{ env.CODENAME }})" >> $GITHUB_STEP_SUMMARY
          echo "* **æ‹‰å–ç­–ç•¥**: å®˜æ–¹æºç åŸå­å¯¹é½" >> $GITHUB_STEP_SUMMARY
          echo "* **ç£ç›˜çŠ¶æ€**: \`$(df -h / | awk 'NR==2 {print $4}')\` available" >> $GITHUB_STEP_SUMMARY
          echo "* **é€»è¾‘è¡Œæ•°**: 1200+ Lines Pipeline" >> $GITHUB_STEP_SUMMARY