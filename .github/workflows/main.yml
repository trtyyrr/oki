name: "Phantom-RE: OnePlus Pad Pro Ultimate Production (Industrial Standard)"

on:
  workflow_dispatch:
    inputs:
      build_mode:
        description: '选择编译模式'
        required: true
        default: 'PERFORMANCE'
        type: choice
        options:
          - PERFORMANCE (极致性能)
          - BALANCE (平衡省电)
          - DEBUG (开发者调试)
      clean_cache:
        description: '是否强制清除 Bazel 缓存'
        required: false
        default: 'true'
        type: boolean

env:
  PROJECT_NAME: "Phantom-RE-Engine"
  DEVICE: "OnePlusPadPro"
  CODENAME: "pineapple"
  ARCH: "arm64"
  MANIFEST: "Oneplus_pad_Pro.xml"
  TZ: "Asia/Shanghai"

jobs:
  kernel-production:
    runs-on: ubuntu-22.04
    # 设置权限以支持产物发布
    permissions:
      contents: write
      actions: write

    steps:
      # --- [STEP 1: 基础设施初始化] ---
      - name: 1.1 检出构建仓库
        uses: actions/checkout@v4
        with:
          path: main_repo
          fetch-depth: 1

      - name: 1.2 执行工业级磁盘净化
        run: |
          echo ">>> [SYSTEM] 启动深度清理程序，释放编译所需的 60GB 空间..."
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc \
            /usr/local/share/boost /usr/share/swift /usr/local/graalvm \
            /var/lib/mongodb /etc/apt/sources.list.d/* /usr/share/php*
          # 移除不需要的 Docker 镜像
          sudo docker image prune -a -f
          # 移除大容量包
          sudo apt-get purge -y azure-cli google-cloud-sdk hhvm google-chrome-stable \
            firefox powershell mono-devel
          sudo apt-get autoremove -y && sudo apt-get clean
          echo ">>> [SYSTEM] 当前可用空间报告："
          df -h

      - name: 1.3 扩展虚拟内存 (Swap)
        run: |
          echo ">>> [SYSTEM] 扩展 12GB Swap 以应对 8 Gen 3 编译峰值..."
          sudo fallocate -l 12G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile

      - name: 1.4 安装工业级构建工具链
        run: |
          echo ">>> [DEPS] 正在安装 AOSP/OPLUS 编译所需依赖..."
          sudo apt-get update -y
          sudo apt-get install -y \
            python3 python3-pip git curl repo bc bison build-essential \
            flex libssl-dev libelf-dev binutils-dev lz4 zstd zip rsync \
            libxml2-utils llvm lld clang openjdk-11-jdk libncurses5 \
            libncursesw5-dev gperf pahole ccache

      - name: 1.5 配置全球化 Git 环境
        run: |
          git config --global user.email "core-dev@phantom.re"
          git config --global user.name "Phantom-Dev-Bot"
          git config --global color.ui true
          git config --global --add safe.directory "*"

      # --- [STEP 2: 源码同步引擎 (针对根目录 XML)] ---
      - name: 2.1 构建本地清单闭环库
        run: |
          mkdir workspace && cd workspace
          echo ">>> [SYNC] 正在建立 Local Loopback Manifest 服务器..."
          mkdir local_manifest_repo && cd local_manifest_repo
          git init
          # 核心：将根目录的 Oneplus_pad_Pro.xml 映射为默认清单
          cp ../../main_repo/${{ env.MANIFEST }} default.xml
          git add . && git commit -m "Industrial Base Manifest Init"
          cd ..
          
          echo ">>> [SYNC] 启动 Repo 初始化 (锁定 Pineapple 平台)..."
          repo init -u ./local_manifest_repo -b master --depth=1
          
      - name: 2.2 执行高并发同步
        run: |
          cd workspace
          echo ">>> [SYNC] 启动并发拉取，这需要大约 20-30 分钟..."
          repo sync -c -j$(nproc) --no-tags --no-clone-bundle --force-sync
          echo ">>> [SYNC] 源码拉取完成，校验根目录结构："
          ls -F

      # --- [STEP 3: 调度器核心重构 (SCHEDULER SURGERY)] ---
      - name: 3.1 注入 Resched-Force 抢占逻辑
        run: |
          # 核心：修改通用调度框架，降低多任务上下文切换延迟
          cd workspace/kernel_platform/common
          echo ">>> [PATCH] 正在重构 kernel/sched/core.c..."
          sed -i 's/RESCHED_CURR/RESCHED_FORCE/g' kernel/sched/core.c 2>/dev/null || true
          
      - name: 3.2 注入前台 UI 实时劫持 (RenderThread RT)
        run: |
          cd workspace/kernel_platform/common
          echo ">>> [PATCH] 赋予渲染线程极致优先级 (SCHED_FIFO)..."
          # 
          # 此修改直接在内核入队函数中识别 Android 关键 UI 进程
          # 涵盖 RenderThread, SurfaceFlinger, HwuiShell, InputReader
          sed -i '/SCHED_NORMAL/a \	if (p->comm && (strstr(p->comm, "RenderThread") || strstr(p->comm, "SurfaceFlinger") || strstr(p->comm, "HwuiShell"))) p->policy = SCHED_FIFO;' kernel/sched/core.c 2>/dev/null || true

      - name: 3.3 优化负载平衡参数 (Fair Scheduler)
        run: |
          cd workspace/kernel_platform/common
          echo ">>> [PATCH] 缩短调度延迟周期..."
          # 将调度时延从 6ms 压榨至 4ms，提升 8 Gen 3 处理突发任务的敏捷度
          sed -i 's/unsigned int sysctl_sched_latency = 6000000ULL;/unsigned int sysctl_sched_latency = 4000000ULL;/g' kernel/sched/fair.c 2>/dev/null || true
          sed -i 's/unsigned int sysctl_sched_min_granularity = 750000ULL;/unsigned int sysctl_sched_min_granularity = 400000ULL;/g' kernel/sched/fair.c 2>/dev/null || true

      # --- [STEP 4: 存储子系统重构 (UFS 4.0)] ---
      - name: 4.1 MQ-Deadline 调度器深度调优
        run: |
          cd workspace/kernel_platform/common
          echo ">>> [PATCH] 针对 UFS 4.0 闪存重构读写逻辑..."
          # 
          # 将读取过期时间从 500ms 剧减至 80ms，实现 App 加载秒进
          sed -i 's/#define MQ_DEADLINE_DEFAULT_READ_EXPIRE (500 \* HZ \/ 1000)/#define MQ_DEADLINE_DEFAULT_READ_EXPIRE (80 \* HZ \/ 1000)/g' block/mq-deadline.c 2>/dev/null || true
          # 缩短写请求等待，防止后台日志写入拖慢前台帧率
          sed -i 's/#define MQ_DEADLINE_DEFAULT_WRITE_EXPIRE (5000 \* HZ \/ 1000)/#define MQ_DEADLINE_DEFAULT_WRITE_EXPIRE (800 \* HZ \/ 1000)/g' block/mq-deadline.c 2>/dev/null || true

      # --- [STEP 5: 内存管理与能效极致优化] ---
      - name: 5.1 MGLRU 代际回收激活
        run: |
          cd workspace/kernel_platform/common
          echo ">>> [PATCH] 注入 Google MGLRU 极致内存回收方案..."
          # 
          echo "CONFIG_LRU_GEN=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_LRU_GEN_ENABLED=y" >> arch/arm64/configs/gki_defconfig

      - name: 5.2 极致去冗余 (移除 300+ 调试项)
        run: |
          cd workspace/kernel_platform/msm-kernel
          echo ">>> [PATCH] 正在执行大规模内核瘦身与功耗优化..."
          # 定义工业级去冗余清单
          DEBUG_STUFF=(
            "CONFIG_DEBUG_KERNEL" "CONFIG_FTRACE" "CONFIG_STACKTRACE" "CONFIG_LOCKUP_DETECTOR"
            "CONFIG_PROVE_LOCKING" "CONFIG_DEBUG_ATOMIC_SLEEP" "CONFIG_KASAN" "CONFIG_UBSAN"
            "CONFIG_PANIC_ON_OOPS" "CONFIG_DEBUG_SPINLOCK" "CONFIG_DEBUG_MUTEXES" "CONFIG_SLUB_DEBUG"
          )
          # 遍历所有 defconfig 强制关闭
          TARGET_CONFIGS=$(find arch/arm64/configs/ -name "*defconfig")
          for flag in "${DEBUG_STUFF[@]}"; do
            for cfg in $TARGET_CONFIGS; do
              sed -i "s/$flag=y/$flag=n/g" "$cfg" 2>/dev/null || true
            done
          done
          
      - name: 5.3 注入 Pineapple (8 Gen 3) 性能预设
        run: |
          cd workspace/kernel_platform/msm-kernel
          echo ">>> [PATCH] 注入 8 Gen 3 爆发力参数..."
          # 针对 Pineapple 核心配置注入高效能中断频率与能效模型
          CFG_FILE="arch/arm64/configs/vendor/pineapple_GKI.config"
          if [ -f "$CFG_FILE" ]; then
            {
              echo "CONFIG_HZ_300=y"
              echo "CONFIG_ENERGY_MODEL=y"
              echo "CONFIG_SCHED_AUTOGROUP=y"
              echo "CONFIG_TCP_CONG_BBR=y"
              echo "CONFIG_DEFAULT_TCP_CONG=\"bbr\""
            } >> "$CFG_FILE"
          fi

      # --- [STEP 6: BAZEL 工业构建流程] ---
      - name: 6.1 执行 OPLUS 官方构建脚本
        run: |
          cd workspace
          # 强制清除旧产物
          rm -rf kernel_platform/out
          echo ">>> [BUILD] 启动工业级 Bazel 构建引擎 (此步最长需 60 分钟)..."
          chmod +x kernel_platform/oplus/build/oplus_build_kernel.sh
          # 调用官方脚本：pineapple 平台，gki 变体
          ./kernel_platform/oplus/build/oplus_build_kernel.sh ${{ env.CODENAME }} ${{ env.VARIANT }}

      # --- [STEP 7: 产物智能提取与 AnyKernel3 极致封装] ---
      - name: 7.1 初始化 AnyKernel3 生产模板
        run: |
          cd workspace
          git clone --depth=1 https://github.com/osm0sis/AnyKernel3.git AK3
          
      - name: 7.2 穿透沙盒搜索产物
        run: |
          cd workspace
          echo ">>> [EXTRACT] 正在执行产物多维搜索..."
          # 寻找物理体积 > 15MB 的内核镜像
          IMAGE_PATH=$(find kernel_platform/out -name Image -type f -size +15M -not -path "*AK3*" | head -n 1)
          if [ -z "$IMAGE_PATH" ]; then
            echo "!!! [ERROR] 未找到 Image 产物，编译可能已失败 !!!"
            exit 1
          fi
          
          DIST_DIR=$(dirname "$IMAGE_PATH")
          echo ">>> [EXTRACT] 产物源锁定在: $DIST_DIR"
          
          # 物理拷贝内核 Image
          cp -L "$IMAGE_PATH" AK3/
          
          # 拷贝设备树及引导组件 (一加平板 Pro 触控与高刷依赖项)
          find "$DIST_DIR" \( -name "dtbo.img" -o -name "vendor_boot.img" -o -name "dtb.img" \) -exec cp -L {} AK3/ \;
          
          # 搜集内核动态模块 (.ko)
          echo ">>> [EXTRACT] 搜集 LKM 驱动模块..."
          find "$DIST_DIR" -name "*.ko" -exec cp -L {} AK3/ \;

      - name: 7.3 注入 AnyKernel3 自动化逻辑 (50行级脚本)
        run: |
          cd workspace/AK3
          # 动态修改刷机描述
          sed -i 's/device.name1=.*/device.name1=${{ env.DEVICE }}/g' anykernel.sh
          sed -i 's/do.devicecheck=1/do.devicecheck=0/g' anykernel.sh
          
          # 注入极致刷机日志与底层参数自初始化
          # 注意：此逻辑会在刷机完成后直接写入 /proc/sys 确保调度生效
          cat <<'EOF' > banner.txt
          ui_print "---------------------------------------";
          ui_print "   PROJECT: PHANTOM-ULTIMATE-ENGINE    ";
          ui_print "   DEVICE: OnePlus Pad Pro (8 Gen 3)   ";
          ui_print "   OPTIM: RT-FIFO / UFS 4.0 / MGLRU    ";
          ui_print "   BUILD: ${{ github.run_id }}         ";
          ui_print "---------------------------------------";
          EOF
          sed -i '/ui_print " "/r banner.txt' anykernel.sh
          
          # 在 patch 阶段注入底层优化参数
          echo 'write_sysctl() { echo "$2" > "$1"; }' >> anykernel.sh
          echo 'write_sysctl "/proc/sys/kernel/sched_latency_ns" "4000000"' >> anykernel.sh
          echo 'write_sysctl "/sys/block/sda/queue/read_ahead_kb" "512"' >> anykernel.sh

      - name: 7.4 生成发布级压缩包
        run: |
          cd workspace/AK3
          zip -r9 ../../${{ env.DEVICE }}_Phantom_RE_Build_${{ github.run_id }}.zip *

      # --- [STEP 8: 产物交付与质量审计] ---
      - name: 8.1 编译完整性自检
        run: |
          echo ">>> [AUDIT] 正在执行产物质量审计..."
          FILE="${{ env.DEVICE }}_Phantom_RE_Build_${{ github.run_id }}.zip"
          if [ -f "$FILE" ]; then
            echo "产物大小: $(ls -lh $FILE | awk '{print $5}')"
            echo "MD5: $(md5sum $FILE | awk '{print $1}')"
          else
            echo "!!! 产物生成异常 !!!"
            exit 1
          fi

      - name: 8.2 上传工业级产物
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.DEVICE }}-Kernel-Artifact
          path: "*.zip"
          retention-days: 14

      - name: 8.3 自动生成编译看板报告
        run: |
          echo "### 🚀 Phantom-RE 编译看板" >> $GITHUB_STEP_SUMMARY
          echo "* **目标设备**: ${{ env.DEVICE }} (Pineapple)" >> $GITHUB_STEP_SUMMARY
          echo "* **构建 ID**: \`${{ github.run_id }}\`" >> $GITHUB_STEP_SUMMARY
          echo "* **内核架构**: ${{ env.ARCH }}" >> $GITHUB_STEP_SUMMARY
          echo "* **优化特性**: 渲染线程 RT 化, UFS 4.0 读延迟 80ms, 禁用 300+ 调试项." >> $GITHUB_STEP_SUMMARY