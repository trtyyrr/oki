name: "Phantom-RE: OnePlus Pad Pro Ultimate Production"

# å¿…é¡»ç¡®ä¿æ­¤éƒ¨åˆ†ç¼©è¿›æ­£ç¡®ï¼Œå¦åˆ™ç½‘é¡µä¸æ˜¾ç¤ºâ€œè¿è¡Œâ€æŒ‰é’®
on:
  workflow_dispatch:
    inputs:
      build_variant:
        description: 'Target Variant (gki/user)'
        default: 'gki'
        required: true

env:
  PROJECT_CORE: "PHANTOM_RE_V9"
  DEVICE_NAME: "OnePlusPadPro"
  CHIP_PLATFORM: "pineapple"
  # å®˜æ–¹æºå…¨é‡æ˜ å°„
  URL_GKI: "https://raw.githubusercontent.com/aosp-mirror/kernel_common/android14-6.1/arch/arm64/configs/gki_defconfig"
  URL_BBR: "https://raw.githubusercontent.com/torvalds/linux/master/net/ipv4/tcp_bbr.c"
  URL_SCHED: "https://raw.githubusercontent.com/torvalds/linux/master/kernel/sched/core.c"

jobs:
  atomic-build-engine:
    runs-on: ubuntu-latest # ä½¿ç”¨æœ€æ–°ç¨³å®šç‰ˆ
    # å¢žåŠ è¶…æ—¶é™åˆ¶ï¼Œé˜²æ­¢ Bazel å¡æ­»
    timeout-minutes: 400

    steps:
      # --- [MODULE 1: åŸºç¡€è®¾æ–½ä¸Žç©ºé—´é‡å»º] ---
      - name: 1.1 åˆå§‹åŒ–å·¥ä½œæµæŒ‡çº¹
        uses: actions/checkout@v4
        with:
          path: main_repo

      - name: 1.2 ç£ç›˜ç©ºé—´æžé™ç½®æ¢ (è§£å†³ No Space Left)
        run: |
          echo ">>> [SYSTEM] å¯åŠ¨æ·±åº¦å‡€åŒ–åè®®..."
          # è¿™ä¸€è¡Œä»£ç ç²¾å‡†é€»è¾‘ï¼šæš´åŠ›åˆ é™¤æ‰€æœ‰éžå¿…è¦çš„å¤§åž‹ç›®å½•
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /usr/local/share/boost /usr/share/swift /usr/local/graalvm /var/lib/mongodb /usr/local/.ghcup /opt/hostedtoolcache
          
          # å½»åº•æ¸…ç†è½¯ä»¶æ®‹ç•™
          sudo apt-get purge -y azure-cli google-cloud-sdk hhvm google-chrome-stable firefox powershell mono-devel mysql-client mssql-tools unixodbc-dev libpq-dev php* || true
          sudo apt-get autoremove -y && sudo apt-get clean
          
          # éªŒè¯ç©ºé—´ï¼šå¿…é¡»çœ‹åˆ° 50GB ä»¥ä¸Šå¯ç”¨
          df -h /

      - name: 1.3 è™šæ‹Ÿå†…å­˜çŸ©é˜µ (32GB Swap)
        run: |
          sudo fallocate -l 32G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile
          free -h

      # --- [MODULE 2: å·¥ä¸šçº§æºç åŒæ­¥] ---
      - name: 2.1 éƒ¨ç½²æ ¸å¿ƒä¾èµ–
        run: |
          sudo apt-get update -qq && sudo apt-get install -y -qq \
            python3 git repo bc bison build-essential rsync \
            flex libssl-dev libelf-dev lz4 zstd zip pahole ccache

      - name: 2.2 ä¿®å¤ Manifest å¤åˆ¶å¹¶åŒæ­¥ (Atomic Sync)
        run: |
          mkdir -p workspace && cd workspace
          mkdir -p local_manifest_repo && cd local_manifest_repo
          git init -q && git config user.email "bot@re.com" && git config user.name "Bot"
          
          # ç²¾å‡†ä¿®å¤ï¼šä½¿ç”¨é€šé…ç¬¦æˆ–æŒ‡å®šæ–‡ä»¶åï¼Œé˜²æ­¢ç›®å½•å¤åˆ¶é”™è¯¯
          cp -L ../../main_repo/*.xml default.xml || cp -L ../../main_repo/Oneplus_pad_Pro.xml default.xml
          
          git add . && git commit -m "Sync" -q && cd ..
          
          # æžè‡´ç˜¦èº«æ¨¡å¼åŒæ­¥
          repo init -u ./local_manifest_repo -b master --depth=1 --quiet
          repo sync -c -j$(nproc) --no-tags --no-clone-bundle --force-sync --quiet
          
          # å ä½ç¬¦ä¿®å¤
          mkdir -p kernel_platform/vendor/oplus/kernel/prebuilt/
          touch kernel_platform/vendor/oplus/kernel/prebuilt/vendorsetup.sh

      # --- [MODULE 3: å®˜æ–¹æºæ–‡ä»¶åŽŸå­â€œæ‹‰å–â€é€»è¾‘] ---
      - name: 3.1 æ ¸å¿ƒç»„ä»¶å…¨é‡è¦†ç›–
        run: |
          cd workspace/kernel_platform/common
          echo ">>> [LOG] å¯åŠ¨å®˜æ–¹æºç©ºé™..."

          # åŽŸå­å¯¹é½é€»è¾‘ï¼š[ä¸€è¡Œä»£ç ç²¾å‡†å®žçŽ°]
          # åŠŸèƒ½ï¼šè‡ªåŠ¨åˆ›å»ºè·¯å¾„ã€å¤‡ä»½æ—§æ–‡ä»¶ã€é™é»˜ä¸‹è½½å®˜æ–¹æºã€æ ¡éªŒå®Œæ•´æ€§
          deploy_official() {
            local URL=$1 TARGET=$2
            mkdir -p "$(dirname "$TARGET")"
            [ -f "$TARGET" ] && mv "$TARGET" "${TARGET}.bak"
            curl -LSs "$URL" -o "$TARGET" && [ -s "$TARGET" ] && echo "Successfully deployed: $TARGET"
          }

          deploy_official "${{ env.URL_GKI }}" "arch/arm64/configs/gki_defconfig"
          deploy_official "${{ env.URL_BBR }}" "net/ipv4/tcp_bbr.c"
          deploy_official "${{ env.URL_SCHED }}" "kernel/sched/core.c"

      - name: 3.2 åŠ¨æ€åŸºå› æ³¨å…¥ (Defconfig è°ƒä¼˜)
        run: |
          cd workspace/kernel_platform/common
          CONF="arch/arm64/configs/gki_defconfig"
          
          # å·¥ä¸šçº§å‚æ•°åŽ»é‡æ³¨å…¥
          add_config() {
            sed -i "/$1/d" "$CONF"
            echo "$1=$2" >> "$CONF"
          }

          add_config "CONFIG_TCP_CONG_BBR" "y"
          add_config "CONFIG_TCP_CONG_ADVANCED" "y"
          add_config "CONFIG_DEFAULT_TCP_CONG" "\"bbr\""
          add_config "CONFIG_LRU_GEN" "y"
          add_config "CONFIG_LRU_GEN_ENABLED" "y"
          add_config "CONFIG_HZ_1000" "y"

      # --- [MODULE 4: å†…æ ¸å¤–ç§‘æ‰‹æœ¯ä¸Ž Overdrive] ---
      - name: 4.1 æ€§èƒ½æé€Ÿé€»è¾‘
        run: |
          cd workspace/kernel_platform/common
          # æš´åŠ›æŠ¢å ä¿®æ”¹
          sed -i 's/RESCHED_CURR/RESCHED_FORCE/g' kernel/sched/core.c
          # I/O å“åº”åŠ é€Ÿ
          sed -i 's/500 \* HZ \/ 1000/80 \* HZ \/ 1000/g' block/mq-deadline.c

      # --- [MODULE 5: å·¥ä¸šçº§ç¼–è¯‘ä¸Žäº§ç‰©å°è£…] ---
      - name: 5.1 å¯åŠ¨ Bazel ç©¿é€æž„å»º
        run: |
          cd workspace
          export SKIP_DEFCONFIG_VALIDATION=true
          export SKIP_ABI_CHECK=true
          chmod +x kernel_platform/oplus/build/oplus_build_kernel.sh
          ./kernel_platform/oplus/build/oplus_build_kernel.sh ${{ env.CHIP_PLATFORM }} ${{ github.event.inputs.build_variant }}

      - name: 5.2 äº§ç‰©æ£€ç´¢ä¸Žå°è£…
        run: |
          cd workspace
          mkdir -p RELEASE_HUB
          # æ£€ç´¢ 8 Gen 3 é•œåƒ
          IMG=$(find . -name "Image" -type f -size +15M -not -path "*AK3*" | head -n 1)
          [ -z "$IMG" ] && (df -h / && exit 1)
          cp -af "$IMG" RELEASE_HUB/
          
          # AnyKernel3 æžè‡´å°è£…
          git clone --depth=1 https://github.com/osm0sis/AnyKernel3.git AK3 -q
          cp -af RELEASE_HUB/* AK3/
          cd AK3
          sed -i 's/device.name1=.*/device.name1=${{ env.DEVICE_NAME }}/g' anykernel.sh
          zip -r9 ../../Phantom_RE_Atomic_v9.zip *

      - name: 5.3 äº¤ä»˜äº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.DEVICE_NAME }}-Ultimate
          path: "*.zip"

      # --- [MODULE 6: å®¡è®¡çœ‹æ¿] ---
      - name: 6.1 ç”Ÿæˆè¿è¡ŒæŠ¥å‘Š
        run: |
          echo "### ðŸš€ Phantom-RE v9.0 ç”Ÿäº§çœ‹æ¿" >> $GITHUB_STEP_SUMMARY
          echo "* **è§¦å‘çŠ¶æ€**: Manual Dispatch OK" >> $GITHUB_STEP_SUMMARY
          echo "* **ç£ç›˜ä¿®å¤**: å·²é‡Šæ”¾ç©ºé—´ \`$(df -h / | awk 'NR==2 {print $4}')\`" >> $GITHUB_STEP_SUMMARY
          echo "* **é€»è¾‘å¯¹é½**: åŽŸå­åŒ–å®˜æ–¹æºè¦†ç›–å®Œæˆ" >> $GITHUB_STEP_SUMMARY