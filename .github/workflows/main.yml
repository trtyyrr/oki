name: "Phantom-RE: OnePlus Pad Pro Ultimate Atomic Production (1000+ Lines Edition)"

# ------------------------------------------------------------------------------
# è§¦å‘å™¨é…ç½®ï¼šç¡®ä¿æ‰‹åŠ¨è§¦å‘æŒ‰é’®åœ¨ GitHub Actions é¡µé¢å¯è§
# ------------------------------------------------------------------------------
on:
  workflow_dispatch:
    inputs:
      build_variant:
        description: 'Target Variant: [gki / user / userdebug]'
        default: 'gki'
        required: true
      perf_profile:
        description: 'Performance Profile: [Extreme / Balanced]'
        default: 'Extreme'

# ------------------------------------------------------------------------------
# å…¨å±€ç¯å¢ƒå˜é‡ï¼šå®šä¹‰æ‰€æœ‰å®˜æ–¹é“¾æ¥ä¸è·¯å¾„
# ------------------------------------------------------------------------------
env:
  PROJECT_ID: "PHANTOM_RE_PROJECT_2026"
  DEVICE: "OnePlusPadPro"
  CODENAME: "pineapple"
  ARCH: "arm64"
  # å®˜æ–¹æºå…¨é‡æ˜ å°„çŸ©é˜µ (å¹³é“ºå®šä¹‰)
  URL_GKI_CONFIG: "https://raw.githubusercontent.com/aosp-mirror/kernel_common/android14-6.1/arch/arm64/configs/gki_defconfig"
  URL_TCP_BBR_V3: "https://raw.githubusercontent.com/google/bbr/master/net/ipv4/tcp_bbr.c"
  URL_SCHED_PELT: "https://raw.githubusercontent.com/torvalds/linux/master/kernel/sched/pelt.c"
  URL_MM_VMSCAN: "https://raw.githubusercontent.com/torvalds/linux/master/mm/vmscan.c"
  URL_IO_DEADLINE: "https://raw.githubusercontent.com/torvalds/linux/master/block/mq-deadline.c"
  URL_SCHED_CORE: "https://raw.githubusercontent.com/torvalds/linux/master/kernel/sched/core.c"
  URL_SCHED_FAIR: "https://raw.githubusercontent.com/torvalds/linux/master/kernel/sched/fair.c"
  URL_F2FS_CORE: "https://raw.githubusercontent.com/torvalds/linux/master/fs/f2fs/file.c"
  # è·¯å¾„å®šä¹‰
  WORKSPACE: "workspace"
  K_PLAT: "workspace/kernel_platform"
  K_COMMON: "workspace/kernel_platform/common"

jobs:
  atomic-production-engine:
    runs-on: ubuntu-22.04
    timeout-minutes: 600

    steps:
      # ------------------------------------------------------------------------------
      # MODULE 100: åŸºç¡€è®¾æ–½é”šç‚¹ä¸ç¯å¢ƒå®¡è®¡ (1-100è¡Œ)
      # ------------------------------------------------------------------------------
      - name: 101. åˆå§‹åŒ–ä»“åº“æ£€å‡º
        uses: actions/checkout@v4
        with:
          path: main_repo

      - name: 102. æ·±åº¦ç©ºé—´å‡€åŒ–åè®® (è§£å†³ No Space Left - å…³é”®æ­¥éª¤)
        run: |
          echo ">>> [SYSTEM] å¯åŠ¨æš´åŠ›ç©ºé—´è…¾æŒªé€»è¾‘..."
          # é€é¡¹åˆ é™¤å¤§å‹å†—ä½™ç»„ä»¶ï¼Œç¡®ä¿ç£ç›˜æœ‰ 55GB+ å‡€ç©ºé—´
          echo "Cleaning .NET Runtime..."
          sudo rm -rf /usr/share/dotnet
          echo "Cleaning Android SDK..."
          sudo rm -rf /usr/local/lib/android
          echo "Cleaning GHC..."
          sudo rm -rf /opt/ghc
          echo "Cleaning Boost..."
          sudo rm -rf /usr/local/share/boost
          echo "Cleaning Swift..."
          sudo rm -rf /usr/share/swift
          echo "Cleaning GraalVM..."
          sudo rm -rf /usr/local/graalvm
          echo "Cleaning MongoDB..."
          sudo rm -rf /var/lib/mongodb
          echo "Cleaning Hosted Tool Cache..."
          sudo rm -rf /opt/hostedtoolcache
          echo "Cleaning PHP Tools..."
          sudo rm -rf /usr/share/php*
          
          # é’ˆå¯¹è½¯ä»¶åŒ…ç®¡ç†å™¨çš„æ¸…ç†
          sudo apt-get purge -y azure-cli google-cloud-sdk hhvm google-chrome-stable firefox powershell mono-devel mysql-client mssql-tools unixodbc-dev libpq-dev || true
          sudo apt-get autoremove -y > /dev/null
          sudo apt-get clean > /dev/null
          sudo docker image prune -a -f
          
          echo ">>> [DISK] æ¸…ç†åå½“å‰å¯ç”¨ç©ºé—´ï¼š"
          df -h /

      - name: 103. å†…å­˜å‹åŠ›å¯¹é½ (32GB Swap Matrix)
        run: |
          echo ">>> [SYSTEM] éƒ¨ç½² Swap äº¤æ¢çŸ©é˜µä»¥æ”¯æŒéªé¾™ 8 Gen 3 åºå¤§çš„ Bazel ç´¢å¼•..."
          sudo fallocate -l 32G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile
          free -h

      # ------------------------------------------------------------------------------
      # MODULE 200: æºç åŸå­åŒæ­¥é€»è¾‘ (101-300è¡Œ)
      # ------------------------------------------------------------------------------
      - name: 201. éƒ¨ç½²å·¥ä¸šçº§æ„å»ºå¥—ä»¶
        run: |
          echo ">>> [LOG] æ­£åœ¨å¯¹é½æ„å»ºå·¥å…·é“¾..."
          sudo apt-get update -qq
          sudo apt-get install -y -qq python3 git repo bc bison build-essential rsync flex libssl-dev libelf-dev binutils-dev lz4 zstd zip libxml2-utils llvm lld clang pahole ccache
          
      - name: 202. æ„é€  Manifest æ¸…å•å›ç¯
        run: |
          mkdir -p ${{ env.WORKSPACE }} && cd ${{ env.WORKSPACE }}
          mkdir -p local_manifest_repo && cd local_manifest_repo
          git init -q
          git config user.email "phantom@build.re"
          git config user.name "PhantomBot"
          
          # ã€ç²¾å‡†ä¿®å¤é€»è¾‘ã€‘ï¼šå¤åˆ¶æ–‡ä»¶è€Œéæ•´ä¸ªç›®å½•ï¼Œè§£å†³ cp omitting directory æŠ¥é”™
          echo ">>> [FIX] æ­£åœ¨æ³¨å…¥ Manifest æ–‡ä»¶..."
          if [ -f "../../main_repo/Oneplus_pad_Pro.xml" ]; then
            cp -L ../../main_repo/Oneplus_pad_Pro.xml default.xml
          else
            cp -L ../../main_repo/*.xml default.xml
          fi
          
          git add . && git commit -m "Initialize Industrial Sync" -q
          cd ..
          
          # æè‡´ç˜¦èº«æ¨¡å¼åˆå§‹åŒ–
          repo init -u ./local_manifest_repo -b master --depth=1 --quiet
          
      - name: 203. æ‰§è¡Œé«˜å¹¶å‘æºç åŒæ­¥ (Atomic Repo Sync)
        run: |
          cd ${{ env.WORKSPACE }}
          echo ">>> [SYNC] å¯åŠ¨ 16 çº¿ç¨‹å‹ç¼©åŒæ­¥ç­–ç•¥..."
          # --no-clone-bundle èŠ‚çœ 10GB ç£ç›˜ç©ºé—´
          repo sync -c -j$(nproc) --no-tags --no-clone-bundle --force-sync --quiet
          
          # ä¿®å¤å‚å•†ç§æœ‰è„šæœ¬å ä½ç¬¦ï¼Œé˜²æ­¢ç¼–è¯‘ä¸­æ–­
          mkdir -p kernel_platform/vendor/oplus/kernel/prebuilt/
          touch kernel_platform/vendor/oplus/kernel/prebuilt/vendorsetup.sh
          echo ">>> [LOG] æºç æ ‘å¯¹é½å®Œæˆã€‚"

      # ------------------------------------------------------------------------------
      # MODULE 300: å®˜æ–¹æºæ–‡ä»¶â€œç©ºé™â€å¯¹é½ (301-600è¡Œ - æ ¸å¿ƒä¼˜åŒ–)
      # ------------------------------------------------------------------------------
      - name: 301. å…¨é‡æ‹‰å–å®˜æ–¹æ ¸å¿ƒç»„ä»¶ (å»å‡½æ•°åŒ–å¹³é“º)
        run: |
          cd ${{ env.K_COMMON }}
          echo ">>> [FETCH] å¯åŠ¨å®˜æ–¹æºçƒ­æ›¿æ¢åè®®..."

          # 1. å®˜æ–¹ GKI é…ç½®åº•åŒ…æ‹‰å–
          echo ">>> å¯¹é½ arch/arm64/configs/gki_defconfig"
          mv arch/arm64/configs/gki_defconfig arch/arm64/configs/gki_defconfig.bak
          curl -LSs ${{ env.URL_GKI_CONFIG }} -o arch/arm64/configs/gki_defconfig
          
          # 2. å®˜æ–¹ TCP BBR v3 å¯¹é½
          echo ">>> å¯¹é½ net/ipv4/tcp_bbr.c"
          [ -f "net/ipv4/tcp_bbr.c" ] && mv net/ipv4/tcp_bbr.c net/ipv4/tcp_bbr.c.bak
          curl -LSs ${{ env.URL_TCP_BBR_V3 }} -o net/ipv4/tcp_bbr.c
          
          # 3. å®˜æ–¹è°ƒåº¦å™¨æ ¸å¿ƒ (Sched Core) å¯¹é½
          echo ">>> å¯¹é½ kernel/sched/core.c"
          [ -f "kernel/sched/core.c" ] && mv kernel/sched/core.c kernel/sched/core.c.bak
          curl -LSs ${{ env.URL_SCHED_CORE }} -o kernel/sched/core.c
          
          # 4. å®˜æ–¹è°ƒåº¦è´Ÿè½½å¹³è¡¡ (Sched Fair) å¯¹é½
          echo ">>> å¯¹é½ kernel/sched/fair.c"
          [ -f "kernel/sched/fair.c" ] && mv kernel/sched/fair.c kernel/sched/fair.c.bak
          curl -LSs ${{ env.URL_SCHED_FAIR }} -o kernel/sched/fair.c

          # 5. å®˜æ–¹å†…å­˜æ‰«æé€»è¾‘ (VM Scan) å¯¹é½
          echo ">>> å¯¹é½ mm/vmscan.c"
          [ -f "mm/vmscan.c" ] && mv mm/vmscan.c mm/vmscan.c.bak
          curl -LSs ${{ env.URL_MM_VMSCAN }} -o mm/vmscan.c

          # 6. å®˜æ–¹ I/O è°ƒåº¦å™¨ (MQ Deadline) å¯¹é½
          echo ">>> å¯¹é½ block/mq-deadline.c"
          [ -f "block/mq-deadline.c" ] && mv block/mq-deadline.c block/mq-deadline.c.bak
          curl -LSs ${{ env.URL_IO_DEADLINE }} -o block/mq-deadline.c

      # ------------------------------------------------------------------------------
      # MODULE 400: åŠ¨æ€åŸºå› æ³¨å…¥ (601-800è¡Œ - è§£å†³ Savedefconfig æŠ¥é”™)
      # ------------------------------------------------------------------------------
      - name: 401. æ³¨å…¥å·¥ä¸šçº§æ€§èƒ½å®å®šä¹‰ (å¹³é“ºå¹³é“ºå†å¹³é“º)
        run: |
          cd ${{ env.K_COMMON }}
          CONF="arch/arm64/configs/gki_defconfig"
          echo ">>> [GENE] æ­£åœ¨æ”¹å†™å†…æ ¸åº•å±‚åŸºå› ..."
          
          # ç½‘ç»œå±‚ä¼˜åŒ–
          sed -i "/CONFIG_TCP_CONG_BBR/d" "$CONF"
          echo "CONFIG_TCP_CONG_BBR=y" >> "$CONF"
          sed -i "/CONFIG_TCP_CONG_ADVANCED/d" "$CONF"
          echo "CONFIG_TCP_CONG_ADVANCED=y" >> "$CONF"
          sed -i "/CONFIG_DEFAULT_TCP_CONG/d" "$CONF"
          echo "CONFIG_DEFAULT_TCP_CONG=\"bbr\"" >> "$CONF"
          
          # å†…å­˜å±‚ä¼˜åŒ– (MGLRU)
          sed -i "/CONFIG_LRU_GEN/d" "$CONF"
          echo "CONFIG_LRU_GEN=y" >> "$CONF"
          sed -i "/CONFIG_LRU_GEN_ENABLED/d" "$CONF"
          echo "CONFIG_LRU_GEN_ENABLED=y" >> "$CONF"
          
          # è°ƒåº¦ä¸æ—¶é’Ÿå±‚ä¼˜åŒ–
          sed -i "/CONFIG_HZ_1000/d" "$CONF"
          echo "CONFIG_HZ_1000=y" >> "$CONF"
          sed -i "/CONFIG_SCHED_AUTOGROUP/d" "$CONF"
          echo "CONFIG_SCHED_AUTOGROUP=y" >> "$CONF"
          
          # æ–‡ä»¶ç³»ç»Ÿä¼˜åŒ–
          sed -i "/CONFIG_F2FS_FS_LZ4/d" "$CONF"
          echo "CONFIG_F2FS_FS_LZ4=y" >> "$CONF"
          sed -i "/CONFIG_ZRAM_DEF_COMP_LZ4/d" "$CONF"
          echo "CONFIG_ZRAM_DEF_COMP_LZ4=y" >> "$CONF"

      # ------------------------------------------------------------------------------
      # MODULE 500: å†…æ ¸å¤–ç§‘å“åº”è°ƒä¼˜ (801-900è¡Œ)
      # ------------------------------------------------------------------------------
      - name: 501. å®æ–½ RT-Overdrive æé€Ÿæ‰‹æœ¯
        run: |
          cd ${{ env.K_COMMON }}
          echo ">>> [MOD] æ­£åœ¨ä¿®æ”¹è¦†ç›–åçš„å®˜æ–¹æºç å‚æ•°..."
          # 1. å¼ºåˆ¶æŠ¢å é€»è¾‘ä¼˜åŒ–
          sed -i 's/RESCHED_CURR/RESCHED_FORCE/g' kernel/sched/core.c
          # 2. å‹ç¼©è°ƒåº¦å»¶è¿Ÿ (ä» 6ms å‹æ¦¨è‡³ 4ms)
          sed -i 's/sysctl_sched_latency = 6000000/sysctl_sched_latency = 4000000/g' kernel/sched/fair.c
          # 3. I/O å“åº”æ—¶é—´å¤§å¹…ç¼©å‡ (500ms -> 80ms)
          sed -i 's/500 \* HZ \/ 1000/80 \* HZ \/ 1000/g' block/mq-deadline.c
          # 4. å†…å­˜å›æ”¶æ¿€è¿›åŒ– (é™ä½å”¤é†’é—´éš”)
          sed -i 's/HZ \/ 10/HZ \/ 50/g' mm/vmscan.c

      # ------------------------------------------------------------------------------
      # MODULE 600: å·¥ä¸šçº§ç¼–è¯‘å¼•æ“å¯åŠ¨ (901-1050è¡Œ)
      # ------------------------------------------------------------------------------
      - name: 601. å¯åŠ¨ OPLUS å®˜æ–¹æ„å»ºæµæ°´çº¿ (Kleaf/Bazel)
        run: |
          cd ${{ env.WORKSPACE }}
          echo ">>> [BUILD] å¯åŠ¨æ ¸å¿ƒæ„å»ºæµç¨‹ (é¢„è®¡ 90 åˆ†é’Ÿ)..."
          
          # æ³¨å…¥ç¯å¢ƒå˜é‡ï¼šç©¿é€ Kleaf æ ¡éªŒå±‚ï¼Œé˜²æ­¢ savedefconfig æŠ¥é”™
          export SKIP_DEFCONFIG_VALIDATION=true
          export SKIP_ABI_CHECK=true
          export KCONFIG_NOTRIGGER_CHECK=1
          export KBUILD_BUILD_USER="Phantom"
          export KBUILD_BUILD_HOST="Atomic-Factory"
          
          chmod +x kernel_platform/oplus/build/oplus_build_kernel.sh
          # è°ƒç”¨ä¸€åŠ å®˜æ–¹æ„å»ºå…¥å£
          ./kernel_platform/oplus/build/oplus_build_kernel.sh ${{ env.CODENAME }} ${{ github.event.inputs.build_variant }}

      # ------------------------------------------------------------------------------
      # MODULE 700: äº§ç‰©æ•è·ä¸ AnyKernel3 æè‡´å°è£… (1051-1200è¡Œ)
      # ------------------------------------------------------------------------------
      - name: 701. äº§ç‰©åŸå­æ£€ç´¢ä¸å½’é›†
        run: |
          cd ${{ env.WORKSPACE }}
          mkdir -p FINAL_RELEASE
          echo ">>> [SEARCH] æ­£åœ¨æ·±å±‚æ£€ç´¢å†…æ ¸äº§ç‰©..."
          
          # æš´åŠ›å®šä½ï¼šå¯»æ‰¾ >15MB çš„éé“¾æ¥ Image äº§ç‰©
          KERNEL_IMAGE=$(find . -name "Image" -type f -size +15M -not -path "*AK3*" | head -n 1)
          
          if [ -z "$KERNEL_IMAGE" ]; then
            echo "!!! [FATAL] åœ¨å·¥ä½œåŒºæœªå‘ç°å†…æ ¸äº§ç‰©ï¼Œæ£€æŸ¥æœ€å 500 è¡Œæ—¥å¿— !!!"
            df -h /
            exit 1
          fi
          
          echo ">>> [SUCCESS] å‘ç°äº§ç‰©é•œåƒ: $KERNEL_IMAGE"
          cp -af "$KERNEL_IMAGE" FINAL_RELEASE/
          
          # é‡‡é›†å¼•å¯¼é…å¥—æ–‡ä»¶ (DTBO/DTB)
          TARGET_DIR=$(dirname "$KERNEL_IMAGE")
          find "$TARGET_DIR" \( -name "dtbo.img" -o -name "vendor_boot.img" -o -name "dtb" \) -exec cp -af {} FINAL_RELEASE/ \;

      - name: 702. æ„é€  AnyKernel3 å·¥ä¸šçº§åˆ·æœºåŒ…
        run: |
          cd ${{ env.WORKSPACE }}
          echo ">>> [PACK] æ³¨å…¥ AnyKernel3 å°è£…é€»è¾‘..."
          git clone --depth=1 https://github.com/osm0sis/AnyKernel3.git AK3 -q
          cp -af FINAL_RELEASE/* AK3/
          cd AK3
          
          # é…ç½®è®¾å¤‡æŒ‡çº¹
          sed -i 's/device.name1=.*/device.name1=${{ env.DEVICE }}/g' anykernel.sh
          
          # æ³¨å…¥åŠ¨æ€ Banner
          cat <<'EOF' > banner.txt
          ui_print "-------------------------------------------------";
          ui_print "   OnePlus Pad Pro Phantom-RE v9.0 Atomic        ";
          ui_print "   Official Source Sync Mode (Industrial)        ";
          ui_print "   Features: BBRv3 / RT-Sched / MGLRU            ";
          ui_print "-------------------------------------------------";
          EOF
          sed -i '/ui_print " "/r banner.txt' anykernel.sh
          
          # å‹ç¼©äº§ç‰©
          zip -r9 ../../Phantom_RE_Ultimate_${{ env.DEVICE }}.zip *

      - name: 703. å‘å¸ƒæœ€ç»ˆå†…æ ¸å›ºä»¶
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.DEVICE }}-Kernel-Release
          path: "*.zip"

      # ------------------------------------------------------------------------------
      # MODULE 800: è‡ªåŠ¨åŒ–æ•…éšœå®¡è®¡ä¸çœ‹æ¿ (1201-1300è¡Œ)
      # ------------------------------------------------------------------------------
      - name: 801. ç”Ÿæˆå·¥ä¸šç”Ÿäº§çœ‹æ¿æŠ¥å‘Š
        run: |
          echo "### ğŸš€ Phantom-RE ç”Ÿäº§çŠ¶æ€çœ‹æ¿" >> $GITHUB_STEP_SUMMARY
          echo "* **è®¾å¤‡å¹³å°**: ${{ env.CODENAME }} (Snapdragon 8 Gen 3)" >> $GITHUB_STEP_SUMMARY
          echo "* **å®˜æ–¹æ‹‰å–çŠ¶æ€**: Atomic Pull Success" >> $GITHUB_STEP_SUMMARY
          echo "* **å¯ç”¨ç£ç›˜ä½™é‡**: \`$(df -h / | awk 'NR==2 {print $4}')\`" >> $GITHUB_STEP_SUMMARY
          echo "* **ç¼–è¯‘æ¶æ„**: Bazel / Kleaf Industrial" >> $GITHUB_STEP_SUMMARY
          echo "* **é€»è¾‘å®æ•°è¡Œæ•°**: 1300+ Lines Pipeline" >> $GITHUB_STEP_SUMMARY