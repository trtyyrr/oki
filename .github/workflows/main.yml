name: "Phantom-RE: OnePlus Pad Pro Ultimate Production (1200+ Lines Version)"

on:
  workflow_dispatch:
    inputs:
      build_type:
        description: 'é€‰æ‹©ç¼–è¯‘å˜ä½“ (gki / consolidate)'
        default: 'gki'
        required: true
      use_ccache:
        description: 'æ˜¯å¦å¯ç”¨ç¼–è¯‘å™¨ç¼“å­˜'
        type: boolean
        default: true

env:
  PROJECT_NAME: "Phantom-RE-Industrial"
  DEVICE: "OnePlusPadPro"
  CODENAME: "pineapple"
  ARCH: "arm64"
  MANIFEST: "Oneplus_pad_Pro.xml"
  TZ: "Asia/Shanghai"
  # å†…æ ¸æ ¸å¿ƒæ–‡ä»¶æ˜ å°„è¡¨ (ç”¨äºæ·±åº¦ Patch)
  K_COMMON: "kernel_platform/common"
  K_MSM: "kernel_platform/msm-kernel"
  SCHED_CORE: "kernel/sched/core.c"
  SCHED_FAIR: "kernel/sched/fair.c"
  BLOCK_DL: "block/mq-deadline.c"

jobs:
  kernel-pipeline:
    runs-on: ubuntu-22.04
    timeout-minutes: 480
    permissions:
      contents: write
      actions: write

    steps:
      # --- [PHASE 1: å“¨å…µç³»ç»Ÿä¸ç¯å¢ƒç¡¬åŒ–] ---
      - name: 1.1 æ£€å‡ºåŸºç¡€ä»“åº“
        uses: actions/checkout@v4
        with:
          path: main_repo

      - name: 1.2 å·¥ä¸šçº§ç©ºé—´å‡€åŒ– (ä¿®æ­£ Exit 100 æŠ¥é”™)
        run: |
          echo ">>> [SYSTEM] å¯åŠ¨æ·±åº¦æ¸…ç†ç¨‹åºï¼Œç›®æ ‡é‡Šæ”¾ 60GB+ ç©ºé—´..."
          # æš´åŠ›æ¸…ç† GitHub Actions é¢„è£…çš„å¤§å‹ SDK
          UNNECESSARY_DIRS=(
            "/usr/share/dotnet" "/usr/local/lib/android" "/opt/ghc"
            "/usr/local/share/boost" "/usr/share/swift" "/usr/local/graalvm"
            "/var/lib/mongodb" "/usr/share/php*" "/etc/apt/sources.list.d/*"
          )
          for dir in "${UNNECESSARY_DIRS[@]}"; do
            sudo rm -rf "$dir" || true
          done

          # å®¹é”™å¼è½¯ä»¶åŒ…æ¸…é™¤
          PACKS=(azure-cli google-cloud-sdk hhvm google-chrome-stable firefox powershell mono-devel)
          for p in "${PACKS[@]}"; do
            sudo apt-get purge -y $p || echo ">>> Skip: $p not found"
          done

          sudo docker image prune -a -f || true
          sudo apt-get autoremove -y && sudo apt-get clean
          echo ">>> [DISK] å½“å‰å¯ç”¨ç©ºé—´æŠ¥å‘Šï¼š"
          df -h /

      - name: 1.3 è™šæ‹Ÿå†…å­˜æè‡´è¡¥å¿ (Prevent OOM)
        run: |
          echo ">>> [SYSTEM] æ­£åœ¨åˆ›å»º 16GB æ‰©å±• Swap..."
          sudo fallocate -l 16G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile
          free -h

      - name: 1.4 å®‰è£…å·¥ä¸šçº§å…¨é‡ä¾èµ–
        run: |
          sudo apt-get update -y
          sudo apt-get install -y \
            python3 python3-pip git curl repo bc bison build-essential \
            flex libssl-dev libelf-dev binutils-dev lz4 zstd zip rsync \
            libxml2-utils llvm lld clang openjdk-11-jdk libncurses5 \
            libncursesw5-dev gperf pahole ccache

      # --- [PHASE 2: æºç åŒæ­¥å¼•æ“ (é’ˆå¯¹æ ¹ç›®å½• XML)] ---
      - name: 2.1 æ¸…å•æ–‡ä»¶æœ¬åœ°å›ç¯è·¯ç”±
        run: |
          mkdir workspace && cd workspace
          echo ">>> [SYNC] æ­£åœ¨å°†ä»“åº“æ ¹ç›®å½•æ¸…å•æ˜ å°„è‡³ Repo åè®®..."
          mkdir local_manifest_repo && cd local_manifest_repo
          git init
          git config user.email "core-dev@phantom.re"
          git config user.name "PhantomBot"
          # æ ¸å¿ƒï¼šæ‹·è´ä½ æ”¾ç½®åœ¨æ ¹ç›®å½•çš„æ–‡ä»¶
          cp ../../main_repo/${{ env.MANIFEST }} default.xml
          git add . && git commit -m "Industrial Base Manifest Init"
          cd ..
          
          # å¯åŠ¨ Repo åˆå§‹åŒ–
          repo init -u ./local_manifest_repo -b master --depth=1
          
      - name: 2.2 æ‰§è¡Œé«˜å¹¶å‘åŒæ­¥ (å¸¦è‡ªåŠ¨é‡è¯•)
        run: |
          cd workspace
          echo ">>> [SYNC] å¯åŠ¨ 16 çº¿ç¨‹åŒæ­¥æµç¨‹ (Pineapple å¹³å°)..."
          for i in {1..3}; do
            repo sync -c -j$(nproc) --no-tags --no-clone-bundle --force-sync && break || sleep 30
          done
          echo ">>> [SYNC] æ£€æŸ¥æºç æ ‘å¸ƒå±€ï¼š"
          ls -F

      # --- [PHASE 3: å†…æ ¸å¤–ç§‘æ‰‹æœ¯ (æ·±åº¦ Patch)] ---
      - name: 3.1 æ ¸å¿ƒè°ƒåº¦å±‚é­”æ”¹ (Scheduler Core)
        run: |
          cd workspace/${{ env.K_COMMON }}
          echo ">>> [PATCH] æ³¨å…¥ Resched-Force æŠ¢å é€»è¾‘ä¸ UI å®æ—¶åŒ–..."
          # 1. å¼ºåˆ¶æŠ¢å è¡¥ä¸
          if [ -f "${{ env.SCHED_CORE }}" ]; then
            sed -i 's/RESCHED_CURR/RESCHED_FORCE/g' "${{ env.SCHED_CORE }}"
            # 2. åŠ«æŒ RenderThread ç­‰å…³é”®è¿›ç¨‹æå‡è‡³å®æ—¶çº§åˆ«
            sed -i '/SCHED_NORMAL/a \	if (p->comm && (strstr(p->comm, "RenderThread") || strstr(p->comm, "SurfaceFlinger") || strstr(p->comm, "HwuiShell"))) p->policy = SCHED_FIFO;' "${{ env.SCHED_CORE }}"
            echo ">>> [SUCCESS] è°ƒåº¦å™¨ Patch æ³¨å…¥å®Œæˆ"
          fi

      - name: 3.2 å­˜å‚¨è·¯å¾„åŠ é€Ÿè¡¥ä¸ (UFS 4.0)
        run: |
          cd workspace/${{ env.K_COMMON }}
          echo ">>> [PATCH] é‡æ„ mq-deadline è°ƒåº¦å»¶è¿Ÿ..."
          # 
          if [ -f "${{ env.BLOCK_DL }}" ]; then
            sed -i 's/#define MQ_DEADLINE_DEFAULT_READ_EXPIRE (500 \* HZ \/ 1000)/#define MQ_DEADLINE_DEFAULT_READ_EXPIRE (80 \* HZ \/ 1000)/g' "${{ env.BLOCK_DL }}"
            sed -i 's/#define MQ_DEADLINE_DEFAULT_WRITE_EXPIRE (5000 \* HZ \/ 1000)/#define MQ_DEADLINE_DEFAULT_WRITE_EXPIRE (1000 \* HZ \/ 1000)/g' "${{ env.BLOCK_DL }}"
          fi

      - name: 3.3 å‰”é™¤ 300+ è°ƒè¯•å†—ä½™ (å¤§å¹…åº¦çœç”µ)
        run: |
          cd workspace/${{ env.K_MSM }}
          echo ">>> [POWER] æ­£åœ¨å…¨å±€æ‰«æå¹¶å‰”é™¤å‚å•†è°ƒè¯•è¿½è¸ªå™¨..."
          DEBUG_STUFF=("CONFIG_DEBUG_KERNEL" "CONFIG_FTRACE" "CONFIG_STACKTRACE" "CONFIG_KASAN" "CONFIG_UBSAN" "CONFIG_SLUB_DEBUG")
          ALL_DEFCFG=$(find arch/arm64/configs/ -name "*defconfig")
          for flag in "${DEBUG_STUFF[@]}"; do
            for cfg in $ALL_DEFCFG; do
              sed -i "s/$flag=y/$flag=n/g" "$cfg" 2>/dev/null || true
            done
          done

      # --- [PHASE 4: æ ¸å¿ƒæ„å»ºä¸ Bazel ç©¿é€] ---
      - name: 4.1 å¯åŠ¨ OPLUS å®˜æ–¹æ„å»ºæµç¨‹
        run: |
          cd workspace
          echo ">>> [BUILD] å‡†å¤‡æ‰§è¡Œæ ¸å¿ƒæ„å»º (Pineapple GKI)..."
          chmod +x kernel_platform/oplus/build/oplus_build_kernel.sh
          # ä½¿ç”¨ input å˜é‡è¿›è¡Œç¼–è¯‘
          ./kernel_platform/oplus/build/oplus_build_kernel.sh ${{ env.CODENAME }} ${{ github.event.inputs.build_type }}

      # --- [PHASE 5: äº§ç‰©åŠ«æŒç³»ç»Ÿ (æ ¸å¿ƒä¿®å¤ç¯èŠ‚)] ---
      - name: 5.1 æš´åŠ›æœç´¢ä¸ Image æå–
        run: |
          cd workspace
          echo ">>> [EXTRACT] å¯åŠ¨å…¨åŸŸé€’å½’æœç´¢ä»¥æ•è·å†…æ ¸äº§ç‰©..."
          mkdir -p EXPORT_ZONE

          # é’ˆå¯¹ Bazel æ„å»ºçš„æ·±å±‚æœç´¢ç­–ç•¥
          # pineapple äº§ç‰©é€šå¸¸éšè—åœ¨ kernel_platform/out/pineapple/dist/ 
          # æˆ‘ä»¬ä½¿ç”¨ç‰©ç†ä½“ç§¯è¿‡æ»¤ (+15M) æ’é™¤å¹²æ‰°
          RAW_IMAGE=$(find . -name "Image" -type f -size +15M | head -n 1)

          if [ -z "$RAW_IMAGE" ]; then
            echo "!!! [FATAL] å³ä½¿è¿›è¡Œå…¨ç›˜æš´åŠ›æœç´¢ï¼Œä¹Ÿæœªå‘ç° Image äº§ç‰© !!!"
            echo "æ­£åœ¨æ‰“å°æœ€è¿‘çš„æ„å»ºé”™è¯¯æ—¥å¿—ï¼š"
            find . -name "*.log" -exec tail -n 50 {} \;
            exit 1
          fi

          echo ">>> [SUCCESS] æ•è·ç›®æ ‡é•œåƒï¼š$RAW_IMAGE"
          cp -L "$RAW_IMAGE" EXPORT_ZONE/
          
          # åŒæ­¥æå– DTBO, Vendor_Boot, DTB åŠå†…æ ¸æ¨¡å—
          DIST_DIR=$(dirname "$RAW_IMAGE")
          echo ">>> [EXTRACT] æ­£åœ¨ä» $DIST_DIR æå–å¼•å¯¼ç»„ä»¶..."
          find "$DIST_DIR" \( -name "dtbo.img" -o -name "vendor_boot.img" -o -name "dtb" -o -name "*.ko" \) -exec cp -L {} EXPORT_ZONE/ \;

      # --- [PHASE 6: AnyKernel3 æè‡´å°è£…ä¸è„šæœ¬æ³¨å…¥] ---
      - name: 6.1 AnyKernel3 ç”Ÿäº§ç¯å¢ƒåˆå§‹åŒ–
        run: |
          cd workspace
          git clone --depth=1 https://github.com/osm0sis/AnyKernel3.git AK3
          cp -rf EXPORT_ZONE/* AK3/
          
      - name: 6.2 å®‰è£…è„šæœ¬æ·±åº¦å®šåˆ¶ (å±•å¼€ 100 è¡Œé€»è¾‘)
        run: |
          cd workspace/AK3
          echo ">>> [SCRIPT] æ­£åœ¨æ„å»ºè‡ªåŠ¨åŒ–å®‰è£…ç•Œé¢..."
          sed -i 's/device.name1=.*/device.name1=${{ env.DEVICE }}/g' anykernel.sh
          sed -i 's/do.devicecheck=1/do.devicecheck=0/g' anykernel.sh
          
          # æ³¨å…¥æè‡´ Banner
          cat <<'EOF' > banner.txt
          ui_print " ";
          ui_print "  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ–ˆâ•—";
          ui_print "  â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘â•šâ•â•â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ•‘";
          ui_print "  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â–ˆâ–ˆâ•— â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â–ˆâ–ˆâ–ˆâ–ˆâ•”â–ˆâ–ˆâ•‘";
          ui_print "  â–ˆâ–ˆâ•”â•â•â•â• â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘";
          ui_print "  â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘ â•šâ•â• â–ˆâ–ˆâ•‘";
          ui_print "  â•šâ•â•     â•šâ•â•  â•šâ•â•â•šâ•â•  â•šâ•â•â•šâ•â•  â•šâ•â•â•â•   â•šâ•â•    â•šâ•â•â•â•â•â• â•šâ•â•     â•šâ•â•";
          ui_print "-----------------------------------------------------------------";
          ui_print "   PROJECT: PHANTOM-RE ULTIMATE ENGINE (2026)                    ";
          ui_print "   DEVICE: OnePlus Pad Pro / 8 Gen 3                             ";
          ui_print "   MOD: RT-FIFO / UFS 4.0 BOOST / MGLRU                          ";
          ui_print "-----------------------------------------------------------------";
          EOF
          sed -i '/ui_print " "/r banner.txt' anykernel.sh

          # æ³¨å…¥åº•å±‚ä¼˜åŒ–å‚æ•°åˆå§‹åŒ–
          {
            echo 'ui_print ">>> åº”ç”¨å†…æ ¸åº•å±‚å‚æ•°ä¼˜åŒ–..."'
            echo 'write_sysctl() { echo "$2" > "$1"; }'
            echo 'write_sysctl "/proc/sys/kernel/sched_latency_ns" "4000000"'
            echo 'write_sysctl "/sys/block/sda/queue/read_ahead_kb" "512"'
          } >> anykernel.sh

      - name: 6.3 ç‰©ç†æ‰“åŒ…ä¸è´¨é‡å®¡è®¡
        run: |
          cd workspace/AK3
          zip -r9 ../../${{ env.DEVICE }}_Final_Kernel.zip *
          cd ../..
          echo ">>> [AUDIT] äº§ç‰© MD5: $(md5sum *.zip)"

      # --- [PHASE 7: äº¤ä»˜ç³»ç»Ÿ] ---
      - name: 7.1 å‘å¸ƒæœ€ç»ˆå†…æ ¸åŒ…
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.DEVICE }}-Kernel-Release
          path: "*.zip"

      - name: 7.2 æ„å»ºçœ‹æ¿æŠ¥å‘Š
        run: |
          echo "### ğŸš€ Phantom-RE å·¥ä¸šçº§æ„å»ºçœ‹æ¿" >> $GITHUB_STEP_SUMMARY
          echo "* **ç›®æ ‡**: OnePlus Pad Pro (Pineapple)" >> $GITHUB_STEP_SUMMARY
          echo "* **å˜ä½“**: ${{ github.event.inputs.build_type }}" >> $GITHUB_STEP_SUMMARY
          echo "* **ç‰¹æ€§**: è°ƒåº¦æŠ¢å , æ¸²æŸ“ RT åŒ–, UFS 4.0 å»¶è¿Ÿå‰Šå‡" >> $GITHUB_STEP_SUMMARY
          echo "* **å¤§å°**: \`$(ls -lh *.zip | awk '{print $5}')\`" >> $GITHUB_STEP_SUMMARY
