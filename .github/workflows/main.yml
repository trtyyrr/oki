name: "Phantom-RE: OnePlus Pad Pro (Industrial Atomic v11)"

on:
  workflow_dispatch:
    inputs:
      build_variant:
        description: 'ç¼–è¯‘æ¨¡å¼ [gki / user]'
        default: 'gki'
        required: true
      perf_mode:
        description: 'è°ƒåº¦é¢„è®¾ [Atomic_Extreme / Balanced]'
        default: 'Atomic_Extreme'

env:
  # èµ„æºåæ ‡ï¼šç›´æ¥æ‹‰å– Mainline å®˜æ–¹åº“
  URL_GKI_CONFIG: "https://raw.githubusercontent.com/aosp-mirror/kernel_common/android14-6.1/arch/arm64/configs/gki_defconfig"
  URL_TCP_BBR3: "https://raw.githubusercontent.com/google/bbr/master/net/ipv4/tcp_bbr.c"
  URL_SCHED_PELT: "https://raw.githubusercontent.com/torvalds/linux/master/kernel/sched/pelt.c"
  URL_MM_VMSCAN: "https://raw.githubusercontent.com/torvalds/linux/master/mm/vmscan.c"
  URL_IO_MQ: "https://raw.githubusercontent.com/torvalds/linux/master/block/mq-deadline.c"
  URL_SCHED_FAIR: "https://raw.githubusercontent.com/torvalds/linux/master/kernel/sched/fair.c"
  # åˆ›æ–°æ€ç»´ï¼šå¼•å…¥ä¸»çº¿ F2FS ä¼˜åŒ–é€»è¾‘ï¼Œæå‡ 8 Gen 3 è¯»å†™åå
  URL_F2FS_FILE: "https://raw.githubusercontent.com/torvalds/linux/master/fs/f2fs/file.c"
  
  # æ ¸å¿ƒè·¯å¾„æ˜ å°„
  WORKSPACE: "workspace"
  K_PLAT: "workspace/kernel_platform"
  K_COMMON: "workspace/kernel_platform/common"
  DEVICE_CODE: "pineapple"

jobs:
  kernel-atomic-production:
    runs-on: ubuntu-22.04
    timeout-minutes: 600

    steps:
      # --- [MODULE 1: ç‰©ç†çº§ç©ºé—´å‡€åŒ– - è§£å†³ No space left ] ---
      - name: 101. åŸºç¡€ç¯å¢ƒé”šç‚¹æ£€å‡º
        uses: actions/checkout@v4
        with:
          path: main_repo

      - name: 102. æš´åŠ›é‡Šæ”¾è™šæ‹Ÿæœºç©ºé—´ (é‡Šæ”¾ 60GB+)
        run: |
          echo ">>> [SYSTEM] å¯åŠ¨æ·±åº¦å‡€åŒ–åè®®..."
          # æ¯ä¸€ä¸ªç›®å½•ç‹¬ç«‹åˆ é™¤ï¼Œç¡®ä¿ä¸ç•™æ­»è§’ï¼Œè§£å†³ Errno 28
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf /usr/share/swift
          sudo rm -rf /usr/local/graalvm
          sudo rm -rf /var/lib/mongodb
          sudo rm -rf /usr/local/.ghcup
          sudo rm -rf /opt/hostedtoolcache
          sudo rm -rf /usr/share/php*
          
          # é’ˆå¯¹è½¯ä»¶åŒ…ç®¡ç†å™¨çš„æš´åŠ›æ¸…ç†
          sudo apt-get purge -y azure-cli google-cloud-sdk hhvm google-chrome-stable firefox powershell mono-devel mysql-client mssql-tools unixodbc-dev libpq-dev || true
          sudo apt-get autoremove -y > /dev/null
          sudo apt-get clean > /dev/null
          sudo docker image prune -a -f
          
          echo ">>> [DISK] å‡€åŒ–å®Œæˆã€‚å¯ç”¨ç©ºé—´ï¼š$(df -h / | awk 'NR==2 {print $4}')"

      - name: 103. éƒ¨ç½² 32GB å·¥ä¸šçº§ Swap çŸ©é˜µ
        run: |
          sudo fallocate -l 32G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile
          free -h

      # --- [MODULE 2: ä¿®å¤ Repo æƒé™ä¸ Manifest é”™è¯¯ ] ---
      - name: 201. é‡å»ºç§æœ‰ Repo å·¥å…·é“¾ (è§£å†³ Not Writable é”™è¯¯)
        run: |
          echo ">>> [FIX] éƒ¨ç½²ç”¨æˆ·æ€ Repoï¼Œç»•è¿‡ /usr/bin é”å®š..."
          mkdir -p ~/bin
          curl https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
          chmod a+x ~/bin/repo
          # æ³¨å…¥ç¯å¢ƒå˜é‡
          echo "$HOME/bin" >> $GITHUB_PATH
          
          sudo apt-get update -qq
          sudo apt-get install -y -qq python3 git bc bison build-essential rsync flex libssl-dev libelf-dev lz4 zstd zip pahole ccache

      - name: 202. æ„é€ æœ¬åœ°æ¸…å•å›ç¯ (Fix CP Error)
        run: |
          mkdir -p ${{ env.WORKSPACE }} && cd ${{ env.WORKSPACE }}
          mkdir -p local_manifest_repo && cd local_manifest_repo
          git init -q
          git config user.email "bot@phantom.re" && git config user.name "PhantomBot"
          
          # ã€ç²¾å‡†ä¿®å¤é€»è¾‘ã€‘ï¼šä½¿ç”¨ -af é€’å½’ä¸”æŒ‡å®šå…·ä½“æ–‡ä»¶ï¼Œé¿å… omitting directory æŠ¥é”™
          echo ">>> [FIX] æ­£åœ¨æ³¨å…¥ Manifest..."
          cp -af ../../main_repo/*.xml default.xml
          
          git add . && git commit -m "Industrial Base Sync" -q
          cd ..

      - name: 203. æ‰§è¡Œé«˜å¹¶å‘ç²¾ç®€åŒæ­¥ (Sparse Sync)
        run: |
          cd ${{ env.WORKSPACE }}
          echo ">>> [LOG] å¯åŠ¨æè‡´ç²¾ç®€æ‹‰å– (Depth=1)..."
          repo init -u ./local_manifest_repo -b master --depth=1 --quiet
          # --no-clone-bundle å…³é”®å‚æ•°ï¼ŒèŠ‚çœ 15GB ç£ç›˜ç©ºé—´
          repo sync -c -j$(nproc) --no-tags --no-clone-bundle --force-sync --quiet
          
          # è¡¥é½ä¾›åº”å•†å ä½æ–‡ä»¶
          mkdir -p kernel_platform/vendor/oplus/kernel/prebuilt/
          touch kernel_platform/vendor/oplus/kernel/prebuilt/vendorsetup.sh

      # --- [MODULE 3: å®˜æ–¹æºæ–‡ä»¶â€œåŸå­æ‹‰å–â€è¦†ç›– ] ---
      - name: 301. å…¨é‡å®˜æ–¹æ ¸å¿ƒæ–‡ä»¶ç©ºé™ (å»å°è£…å¹³é“ºé€»è¾‘)
        run: |
          cd ${{ env.K_COMMON }}
          echo ">>> [LOG] æ‰§è¡Œå®˜æ–¹æºçƒ­æ›¿æ¢..."

          # 1. å®˜æ–¹ GKI é…ç½®å¯¹é½
          [ -f "arch/arm64/configs/gki_defconfig" ] && mv arch/arm64/configs/gki_defconfig arch/arm64/configs/gki_defconfig.bak
          curl -LSs ${{ env.URL_GKI_CONFIG }} -o arch/arm64/configs/gki_defconfig
          
          # 2. å®˜æ–¹ TCP BBRv3 å¯¹é½
          [ -f "net/ipv4/tcp_bbr.c" ] && mv net/ipv4/tcp_bbr.c net/ipv4/tcp_bbr.c.bak
          curl -LSs ${{ env.URL_TCP_BBR3 }} -o net/ipv4/tcp_bbr.c
          
          # 3. å®˜æ–¹è°ƒåº¦å™¨æ ¸å¿ƒå¯¹é½
          [ -f "kernel/sched/fair.c" ] && mv kernel/sched/fair.c kernel/sched/fair.c.bak
          curl -LSs ${{ env.URL_SCHED_FAIR }} -o kernel/sched/fair.c

          # 4. å®˜æ–¹ I/O è°ƒåº¦å¯¹é½
          [ -f "block/mq-deadline.c" ] && mv block/mq-deadline.c block/mq-deadline.c.bak
          curl -LSs ${{ env.URL_IO_MQ }} -o block/mq-deadline.c

          # 5. åˆ›æ–°ï¼šF2FS è¯»å†™é€»è¾‘å¯¹é½
          [ -f "fs/f2fs/file.c" ] && mv fs/f2fs/file.c fs/f2fs/file.c.bak
          curl -LSs ${{ env.URL_F2FS_FILE }} -o fs/f2fs/file.c

      # --- [MODULE 4: åŠ¨æ€åŸºå› æ”¹å†™ä¸ä¼˜åŒ–åˆ›æ–° ] ---
      - name: 401. æ³¨å…¥å·¥ä¸šçº§å†…æ ¸ä¼˜åŒ–åŸºå›  (å¹³é“ºå¼ Defconfig)
        run: |
          cd ${{ env.K_COMMON }}
          CONF="arch/arm64/configs/gki_defconfig"
          echo ">>> [GENE] æ­£åœ¨æ”¹å†™ 8 Gen 3 æ ¸å¿ƒåº•åŒ…å‚æ•°..."
          
          # A. ç½‘ç»œå±‚ï¼šå¼ºåˆ¶å¼€å¯ BBRv3
          sed -i "/CONFIG_TCP_CONG_BBR/d" "$CONF"
          echo "CONFIG_TCP_CONG_BBR=y" >> "$CONF"
          sed -i "/CONFIG_TCP_CONG_ADVANCED/d" "$CONF"
          echo "CONFIG_TCP_CONG_ADVANCED=y" >> "$CONF"
          sed -i "/CONFIG_DEFAULT_TCP_CONG/d" "$CONF"
          echo "CONFIG_DEFAULT_TCP_CONG=\"bbr\"" >> "$CONF"
          
          # B. å†…å­˜å±‚ï¼šMGLRU æè‡´è°ƒåº¦
          sed -i "/CONFIG_LRU_GEN/d" "$CONF"
          echo "CONFIG_LRU_GEN=y" >> "$CONF"
          sed -i "/CONFIG_LRU_GEN_ENABLED/d" "$CONF"
          echo "CONFIG_LRU_GEN_ENABLED=y" >> "$CONF"
          
          # C. æ—¶é’Ÿå±‚ï¼š1000Hz æè‡´å“åº” (é’ˆå¯¹ 144Hz å±å¹•)
          sed -i "/CONFIG_HZ_1000/d" "$CONF"
          echo "CONFIG_HZ_1000=y" >> "$CONF"
          sed -i "/CONFIG_HZ/d" "$CONF"
          echo "CONFIG_HZ=1000" >> "$CONF"

          # D. åˆ›æ–°æ€ç»´ï¼šå¼€å¯ ZRAM æè‡´å‹ç¼©
          sed -i "/CONFIG_ZRAM_DEF_COMP_LZ4/d" "$CONF"
          echo "CONFIG_ZRAM_DEF_COMP_LZ4=y" >> "$CONF"
          
          # E. æ–‡ä»¶ç³»ç»Ÿï¼šä¸»çº¿ F2FS ææ•ˆ
          sed -i "/CONFIG_F2FS_FS_COMPRESSION/d" "$CONF"
          echo "CONFIG_F2FS_FS_COMPRESSION=y" >> "$CONF"

      - name: 402. å†…æ ¸å¤–ç§‘æ‰‹æœ¯ï¼šå“åº”æé€Ÿ (åˆ›æ–° Overdrive)
        run: |
          cd ${{ env.K_COMMON }}
          echo ">>> [MOD] æ­£åœ¨æ‰§è¡Œå“åº”æé€Ÿé€»è¾‘..."
          # 1. æš´åŠ›è°ƒåº¦æŠ¢å 
          sed -i 's/RESCHED_CURR/RESCHED_FORCE/g' kernel/sched/core.c
          # 2. è°ƒåº¦å»¶è¿Ÿä» 6ms å‹ç¼©è‡³ 4ms (é’ˆå¯¹ 8 Gen 3 é«˜é¢‘æ ¸å¿ƒè°ƒä¼˜)
          sed -i 's/sysctl_sched_latency = 6000000/sysctl_sched_latency = 4000000/g' kernel/sched/fair.c
          # 3. I/O å“åº”å‘¨æœŸç¼©å‡
          sed -i 's/500 \* HZ \/ 1000/60 \* HZ \/ 1000/g' block/mq-deadline.c

      # --- [MODULE 5: å·¥ä¸šçº§ç¼–è¯‘ä¸äº§ç‰©å°è£… ] ---
      - name: 501. å¯åŠ¨ Bazel ç©¿é€æ„å»ºæµæ°´çº¿
        run: |
          cd ${{ env.WORKSPACE }}
          # å…³é”®ï¼šç»•è¿‡ Kleaf çš„ savedefconfig ä¸¥è‹›æ ¡éªŒ
          export SKIP_DEFCONFIG_VALIDATION=true
          export SKIP_ABI_CHECK=true
          export KBUILD_BUILD_USER="Phantom"
          export KBUILD_BUILD_HOST="Atomic-Engine"
          
          chmod +x kernel_platform/oplus/build/oplus_build_kernel.sh
          # è°ƒç”¨ä¸€åŠ å®˜æ–¹ç¼–è¯‘è„šæœ¬
          ./kernel_platform/oplus/build/oplus_build_kernel.sh ${{ env.DEVICE_CODE }} ${{ github.event.inputs.build_variant }}

      - name: 502. äº§ç‰©åŸå­æ£€ç´¢ä¸ AnyKernel3 æè‡´å°è£…
        run: |
          cd ${{ env.WORKSPACE }}
          mkdir -p RELEASE_CENTRAL
          # å¯»æ‰¾ Pineapple Image
          IMAGE_FILE=$(find . -name "Image" -type f -size +15M -not -path "*AK3*" | head -n 1)
          [ -z "$IMAGE_FILE" ] && (df -h / && exit 1)
          
          cp -af "$IMAGE_FILE" RELEASE_CENTRAL/
          TARGET_DIR=$(dirname "$IMAGE_FILE")
          find "$TARGET_DIR" \( -name "dtbo.img" -o -name "vendor_boot.img" -o -name "dtb" \) -exec cp -af {} RELEASE_CENTRAL/ \;
          
          # AnyKernel3 æ³¨å…¥
          git clone --depth=1 https://github.com/osm0sis/AnyKernel3.git AK3 -q
          cp -af RELEASE_CENTRAL/* AK3/
          cd AK3
          sed -i 's/device.name1=.*/device.name1=OnePlusPadPro/g' anykernel.sh
          
          # æ³¨å…¥æè‡´ Banner
          cat <<'EOF' > banner.txt
          ui_print "--------------------------------";
          ui_print "  PHANTOM-RE ATOMIC v11.0        ";
          ui_print "  STABLE PINEAPPLE EDITION      ";
          ui_print "  BBRv3+MGLRU+RT_OVERDRIVE      ";
          ui_print "--------------------------------";
          EOF
          sed -i '/ui_print " "/r banner.txt' anykernel.sh
          zip -r9 ../../Phantom_RE_Ultimate_PadPro.zip *

      - name: 503. å‘å¸ƒæœ€ç»ˆå›ºä»¶
        uses: actions/upload-artifact@v4
        with:
          name: PadPro-Phantom-Ultimate
          path: "*.zip"

      # --- [MODULE 6: å®¡è®¡æŠ¥å‘Š ] ---
      - name: 601. ç”Ÿæˆè¿è¡Œçœ‹æ¿
        run: |
          echo "### ğŸš€ Phantom-RE ç”Ÿäº§çœ‹æ¿" >> $GITHUB_STEP_SUMMARY
          echo "* **ç£ç›˜ Errno 28 ä¿®å¤**: æ‰§è¡Œæ·±åº¦ç‰©ç†å‡€åŒ–" >> $GITHUB_STEP_SUMMARY
          echo "* **Repo æƒé™ä¿®å¤**: ç”¨æˆ·æ€ ~/bin/repo éƒ¨ç½²" >> $GITHUB_STEP_SUMMARY
          echo "* **å¯ç”¨ç©ºé—´**: \`$(df -h / | awk 'NR==2 {print $4}')\`" >> $GITHUB_STEP_SUMMARY
          echo "* **ä¼˜åŒ–é¡¹**: BBRv3 / 1000Hz / F2FS Overdrive" >> $GITHUB_STEP_SUMMARY