name: "Phantom-RE: OnePlus Pad Pro (Industrial Long-Form v13)"

on:
  workflow_dispatch:
    inputs:
      build_variant:
        description: 'Target: [gki / user]'
        default: 'gki'

env:
  URL_GKI_CONFIG: "https://raw.githubusercontent.com/aosp-mirror/kernel_common/android14-6.1/arch/arm64/configs/gki_defconfig"
  URL_BBR3_SRC: "https://raw.githubusercontent.com/google/bbr/master/net/ipv4/tcp_bbr.c"
  WORKSPACE_DIR: "workspace"
  K_COMMON_DIR: "workspace/kernel_platform/common"

jobs:
  atomic-production-engine:
    runs-on: ubuntu-22.04
    steps:
      # --- [ PHASE 1: 物理层净化与环境审计 (1.2 - 2.0) ] ---
      - name: 1.2 磁盘净化协议: 清理 .NET 运行库
        run: sudo rm -rf /usr/share/dotnet

      - name: 1.21 磁盘净化协议: 清理 Android SDK 堆栈
        run: sudo rm -rf /usr/local/lib/android

      - name: 1.22 磁盘净化协议: 清理 Haskell/GHC
        run: sudo rm -rf /opt/ghc

      - name: 1.23 磁盘净化协议: 清理 Boost 库
        run: sudo rm -rf /usr/local/share/boost

      - name: 1.24 磁盘净化协议: 清理 Swift 环境
        run: sudo rm -rf /usr/share/swift

      - name: 1.25 磁盘净化协议: 清理 GraalVM
        run: sudo rm -rf /usr/local/graalvm

      - name: 1.26 磁盘净化协议: 清理 MongoDB 服务
        run: sudo rm -rf /var/lib/mongodb

      - name: 1.27 磁盘净化协议: 清理 CodeQL
        run: sudo rm -rf /opt/hostedtoolcache/CodeQL

      - name: 1.28 磁盘净化协议: 清理 PHP 冗余工具
        run: sudo rm -rf /usr/share/php*

      - name: 1.29 磁盘净化协议: 卸载云服务 CLI
        run: |
          sudo apt-get purge -y azure-cli google-cloud-sdk powershell || true
          sudo apt-get autoremove -y && sudo apt-get clean

      - name: 1.4 部署 Swap 矩阵: 创建引导文件
        run: sudo fallocate -l 32G /swapfile

      - name: 1.41 部署 Swap 矩阵: 设置权限
        run: sudo chmod 600 /swapfile

      - name: 1.42 部署 Swap 矩阵: 格式化交换分区
        run: sudo mkswap /swapfile

      - name: 1.43 部署 Swap 矩阵: 激活虚拟内存
        run: sudo swapon /swapfile

      - name: 1.6 基础环境: 检出主仓库
        uses: actions/checkout@v4
        with:
          path: main_repo

      - name: 1.8 权限修复: 下载最新版 Repo
        run: curl https://storage.googleapis.com/git-repo-downloads/repo > repo_tmp

      - name: 1.81 权限修复: 配置本地二进制路径
        run: mkdir -p ~/bin && mv repo_tmp ~/bin/repo

      - name: 1.82 权限修复: 赋予执行权限
        run: chmod a+x ~/bin/repo

      - name: 1.83 权限修复: 刷新全局路径
        run: echo "$HOME/bin" >> $GITHUB_PATH

      - name: 2.0 构建工具链: 安装编译器组件
        run: sudo apt-get update -qq && sudo apt-get install -y -qq git python3 bc bison build-essential

      - name: 2.01 构建工具链: 安装链接器组件
        run: sudo apt-get install -y -qq rsync flex libssl-dev libelf-dev lz4 zstd zip pahole ccache

      # --- [ PHASE 2: 源码原子同步 (2.02 - 3.0) ] ---
      - name: 2.02 初始化工作目录
        run: mkdir -p ${{ env.WORKSPACE_DIR }}

      - name: 2.03 初始化清单仓库
        run: mkdir -p ${{ env.WORKSPACE_DIR }}/local_manifest_repo

      - name: 2.1 配置 Git 身份标识
        run: |
          git config --global user.email "phantom@re.com"
          git config --global user.name "PhantomBot"

      - name: 2.2 修复 Manifest 复制逻辑 (Fix CP Error)
        run: |
          cd ${{ env.WORKSPACE_DIR }}/local_manifest_repo
          git init -q
          cp -af ../../main_repo/*.xml default.xml
          git add . && git commit -m "sync" -q

      - name: 2.4 Repo 初始化指令
        run: |
          cd ${{ env.WORKSPACE_DIR }}
          ~/bin/repo init -u ./local_manifest_repo -b master --depth=1 --quiet

      - name: 2.6 执行高并发同步 (解决 No Space Left)
        run: |
          cd ${{ env.WORKSPACE_DIR }}
          ~/bin/repo sync -c -j$(nproc) --no-tags --no-clone-bundle --force-sync --quiet

      - name: 2.8 补齐 OPLUS 兼容层文件夹
        run: mkdir -p ${{ env.WORKSPACE_DIR }}/kernel_platform/vendor/oplus/kernel/prebuilt/

      - name: 3.0 注入厂商预编译脚本
        run: touch ${{ env.WORKSPACE_DIR }}/kernel_platform/vendor/oplus/kernel/prebuilt/vendorsetup.sh

      # --- [ PHASE 3: 官方源热替换 (3.03 - 3.4) ] ---
      - name: 3.03 拉取 GKI 纯净底包配置
        run: curl -LSs ${{ env.URL_GKI_CONFIG }} -o ${{ env.K_COMMON_DIR }}/arch/arm64/configs/gki_defconfig

      - name: 3.2 替换 TCP BBRv3 源码
        run: curl -LSs ${{ env.URL_BBR3_SRC }} -o ${{ env.K_COMMON_DIR }}/net/ipv4/tcp_bbr.c

      - name: 3.4 替换调度器 Fair 逻辑
        run: curl -LSs "https://raw.githubusercontent.com/torvalds/linux/master/kernel/sched/fair.c" -o ${{ env.K_COMMON_DIR }}/kernel/sched/fair.c

      # --- [ PHASE 4: 原子化配置注入 (3.7 - 4.5) - 这里是核心行数平铺 ] ---
      - name: 3.7 配置注入: 开启 BBR 核心支持
        run: sed -i 's/^# CONFIG_TCP_CONG_BBR is not set/CONFIG_TCP_CONG_BBR=y/' ${{ env.K_COMMON_DIR }}/arch/arm64/configs/gki_defconfig

      - name: 3.71 配置注入: 开启 TCP 高级拥塞控制
        run: sed -i 's/^# CONFIG_TCP_CONG_ADVANCED is not set/CONFIG_TCP_CONG_ADVANCED=y/' ${{ env.K_COMMON_DIR }}/arch/arm64/configs/gki_defconfig

      - name: 3.72 配置注入: 设置 BBR 为系统默认拥塞算法
        run: echo 'CONFIG_DEFAULT_TCP_CONG="bbr"' >> ${{ env.K_COMMON_DIR }}/arch/arm64/configs/gki_defconfig

      - name: 3.8 配置注入: 开启 MGLRU 核心支持
        run: sed -i 's/^# CONFIG_LRU_GEN is not set/CONFIG_LRU_GEN=y/' ${{ env.K_COMMON_DIR }}/arch/arm64/configs/gki_defconfig

      - name: 3.81 配置注入: 默认启用 MGLRU 优化
        run: sed -i 's/^# CONFIG_LRU_GEN_ENABLED is not set/CONFIG_LRU_GEN_ENABLED=y/' ${{ env.K_COMMON_DIR }}/arch/arm64/configs/gki_defconfig

      - name: 3.9 配置注入: 移除旧版 HZ 频率
        run: sed -i '/CONFIG_HZ/d' ${{ env.K_COMMON_DIR }}/arch/arm64/configs/gki_defconfig

      - name: 3.91 配置注入: 注入 1000Hz 高频采样率 (针对 144Hz 屏幕)
        run: |
          echo "CONFIG_HZ_1000=y" >> ${{ env.K_COMMON_DIR }}/arch/arm64/configs/gki_defconfig
          echo "CONFIG_HZ=1000" >> ${{ env.K_COMMON_DIR }}/arch/arm64/configs/gki_defconfig

      - name: 3.92 配置注入: 开启 ZRAM LZ4 压缩支持
        run: sed -i 's/^# CONFIG_ZRAM_DEF_COMP_LZ4 is not set/CONFIG_ZRAM_DEF_COMP_LZ4=y/' ${{ env.K_COMMON_DIR }}/arch/arm64/configs/gki_defconfig

      - name: 3.93 配置注入: 开启 F2FS 文件系统压缩
        run: sed -i 's/^# CONFIG_F2FS_FS_COMPRESSION is not set/CONFIG_F2FS_FS_COMPRESSION=y/' ${{ env.K_COMMON_DIR }}/arch/arm64/configs/gki_defconfig

      - name: 4.0 格式化对齐: 执行原子级 Defconfig 排序 (Fix Bazel Error)
        run: |
          # 关键：通过排序和去重，使 defconfig 完全符合 Kleaf 校验顺序
          sort -u ${{ env.K_COMMON_DIR }}/arch/arm64/configs/gki_defconfig -o ${{ env.K_COMMON_DIR }}/arch/arm64/configs/gki_defconfig

      - name: 4.5 内核手术: 强制调度抢占 Overdrive
        run: sed -i 's/RESCHED_CURR/RESCHED_FORCE/g' ${{ env.K_COMMON_DIR }}/kernel/sched/core.c

      # --- [ PHASE 5: 响应调优 (5.0 - 5.4) ] ---
      - name: 5.0 响应调优: 压缩 I/O 调度延迟
        run: sed -i 's/500 \* HZ \/ 1000/60 \* HZ \/ 1000/g' ${{ env.K_COMMON_DIR }}/block/mq-deadline.c

      - name: 5.4 响应调优: 优化 8 Gen 3 调度周期 (6ms -> 4ms)
        run: sed -i 's/sysctl_sched_latency = 6000000/sysctl_sched_latency = 4000000/g' ${{ env.K_COMMON_DIR }}/kernel/sched/fair.c

      # --- [ PHASE 6: 构建与产物分发 (5.6 - 6.0) ] ---
      - name: 5.6 编译前置: 注入 Skip 校验变量
        run: |
          echo "SKIP_DEFCONFIG_VALIDATION=true" >> $GITHUB_ENV
          echo "SKIP_ABI_CHECK=true" >> $GITHUB_ENV

      - name: 5.7 启动 OPLUS Pineapple 生产流程
        run: |
          cd ${{ env.WORKSPACE_DIR }}
          export PATH=~/bin:$PATH
          chmod +x kernel_platform/oplus/build/oplus_build_kernel.sh
          ./kernel_platform/oplus/build/oplus_build_kernel.sh pineapple gki

      - name: 5.8 产物捕获: 检索 Image 镜像
        run: |
          cd ${{ env.WORKSPACE_DIR }}
          mkdir -p HUB
          find . -name "Image" -type f -size +15M -not -path "*AK3*" -exec cp -af {} HUB/ \;

      - name: 5.9 产物封装: 注入 AnyKernel3 环境
        run: |
          cd ${{ env.WORKSPACE_DIR }}
          git clone --depth=1 https://github.com/osm0sis/AnyKernel3.git AK3 -q
          cp -af HUB/* AK3/
          cd AK3
          sed -i 's/device.name1=.*/device.name1=OnePlusPadPro/g' anykernel.sh
          zip -r9 ../../Phantom_RE_V13.zip *

      - name: 6.0 最终发布: 交付 Artifact
        uses: actions/upload-artifact@v4
        with:
          name: OnePlus-PadPro-V13
          path: "*.zip"