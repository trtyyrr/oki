name: "Phantom-RE: OnePlus Pad Pro Industrial Pipeline (Official Source Sync Mode)"

on:
  workflow_dispatch:
    inputs:
      build_variant:
        description: 'ç¼–è¯‘æ¨¡å¼: gki (user) / consolidate (userdebug)'
        default: 'gki'
        required: true
      clean_level:
        description: 'æ¸…ç†ç­‰çº§: aggressive / standard'
        default: 'aggressive'

env:
  # åŸºç¡€å®šä¹‰
  PROJECT_ID: "PHANTOM_RE_PIX_2026"
  DEVICE: "OnePlusPadPro"
  CODENAME: "pineapple"
  ARCH: "arm64"
  MANIFEST: "Oneplus_pad_Pro.xml"
  # è·¯å¾„å®å®šä¹‰
  WORKSPACE: "workspace"
  K_PLAT: "workspace/kernel_platform"
  K_COMMON: "workspace/kernel_platform/common"
  K_MSM: "workspace/kernel_platform/msm-kernel"
  # å®˜æ–¹æºæŒ‡çº¹æ˜ å°„ (ç”¨äºå…¨é‡æ‹‰å–)
  URL_GKI_DEFCONFIG: "https://raw.githubusercontent.com/aosp-mirror/kernel_common/android14-6.1/arch/arm64/configs/gki_defconfig"
  URL_TCP_BBR: "https://raw.githubusercontent.com/torvalds/linux/master/net/ipv4/tcp_bbr.c"
  URL_PELT: "https://raw.githubusercontent.com/torvalds/linux/master/kernel/sched/pelt.c"
  URL_VMSCAN: "https://raw.githubusercontent.com/torvalds/linux/master/mm/vmscan.c"
  URL_DEADLINE: "https://raw.githubusercontent.com/torvalds/linux/master/block/mq-deadline.c"
  URL_SCHED_CORE: "https://raw.githubusercontent.com/torvalds/linux/master/kernel/sched/core.c"

jobs:
  kernel-production:
    runs-on: ubuntu-22.04
    timeout-minutes: 480 # 8å°æ—¶è¶…é•¿æ„å»º

    steps:
      # --- [MODULE 1: åŸºç¡€è®¾æ–½å®¡è®¡ä¸åŠ å›º] ---
      - name: 1.1 æ£€å‡ºä¸»ä»“åº“
        uses: actions/checkout@v4
        with:
          path: main_repo

      - name: 1.2 ç‰©ç†çº§ç£ç›˜å‡€åŒ– (Aggressive Protocol)
        run: |
          echo ">>> [SYSTEM] æ­£åœ¨å¯åŠ¨å…¨é‡ç£ç›˜å›æ”¶é€»è¾‘..."
          # é’ˆå¯¹ GitHub Actions è™šæ‹Ÿæœºçš„å†—ä½™ç»„ä»¶è¿›è¡Œç²¾å‡†å‰”é™¤
          # è¿™æ ·å¯ä»¥è…¾å‡ºçº¦ 60GB ç©ºé—´ï¼Œé˜²æ­¢ Bazel æ„å»ºä¸­æ–­
          PATHS_TO_PURGE=(
            "/usr/share/dotnet" "/usr/local/lib/android" "/opt/ghc"
            "/usr/local/share/boost" "/usr/share/swift" "/usr/local/graalvm"
            "/var/lib/mongodb" "/usr/share/php*" "/etc/apt/sources.list.d/*"
          )
          for dir in "${PATHS_TO_PURGE[@]}"; do
            if [ -d "$dir" ]; then
              echo "Purging: $dir"
              sudo rm -rf "$dir" || true
            fi
          done
          # è§£å†³ä¹‹å‰ä½ é‡åˆ°çš„ apt å¸è½½æŠ¥é”™
          sudo apt-get purge -y azure-cli google-cloud-sdk hhvm google-chrome-stable firefox powershell mono-devel || true
          sudo apt-get autoremove -y && sudo apt-get clean
          echo ">>> [DISK] å‡€åŒ–åå¯ç”¨ç©ºé—´: $(df -h / | awk 'NR==2 {print $4}')"

      - name: 1.3 è™šæ‹Ÿå†…å­˜çŸ©é˜µéƒ¨ç½² (32GB Swap)
        run: |
          echo ">>> [SYSTEM] éƒ¨ç½²è¶…å¤§è§„æ¨¡ Swap ä»¥åº”å¯¹ 8 Gen 3 ç¼–è¯‘å‹åŠ›..."
          sudo fallocate -l 32G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile
          free -h

      # --- [MODULE 2: å·¥ä¸šçº§ä¾èµ–å¯¹é½] ---
      - name: 2.1 éƒ¨ç½² AOSP æ„å»ºå¥—ä»¶
        run: |
          sudo apt-get update -y
          sudo apt-get install -y \
            python3 python3-pip git curl repo bc bison build-essential \
            flex libssl-dev libelf-dev binutils-dev lz4 zstd zip rsync \
            libxml2-utils llvm lld clang openjdk-11-jdk pahole ccache \
            libncurses5 libncursesw5-dev gperf

      # --- [MODULE 3: æºç åè®®é—­ç¯ (Manifest Engine)] ---
      - name: 3.1 æ„é€ æœ¬åœ°æ¸…å•å›ç¯
        run: |
          mkdir -p ${{ env.WORKSPACE }} && cd ${{ env.WORKSPACE }}
          mkdir -p local_manifest_repo && cd local_manifest_repo
          git init
          git config user.email "bot@phantom.re"
          git config user.name "PhantomBot"
          cp ../../main_repo/${{ env.MANIFEST }} default.xml
          git add . && git commit -m "Industrial Base Manifest Integration"
          cd ..
          # åˆå§‹åŒ– Repo
          repo init -u ./local_manifest_repo -b master --depth=1

      - name: 3.2 é«˜å¹¶å‘æºç åŒæ­¥
        run: |
          cd ${{ env.WORKSPACE }}
          echo ">>> [SYNC] å¯åŠ¨ 16 çº¿ç¨‹å¹¶å‘æ‹‰å– (Pineapple å¹³å°)..."
          for i in {1..3}; do
            repo sync -c -j$(nproc) --no-tags --no-clone-bundle --force-sync && break || sleep 30
          done
          # è¡¥é½ä¸€åŠ ç‰¹æœ‰çš„å‚å•†å ä½æ–‡ä»¶ï¼Œè§£å†³ä½ ä¹‹å‰çš„æŠ¥é”™
          mkdir -p vendor/oplus/kernel/prebuilt/
          touch vendor/oplus/kernel/prebuilt/vendorsetup.sh
          echo ">>> [SUCCESS] æºç æ ‘å¯¹é½å®Œæˆã€‚"

      # --- [MODULE 4: å®˜æ–¹æºå…¨é‡ç©ºé™ (æ ¸å¿ƒä¿®å¤ç¯èŠ‚)] ---
      - name: 4.1 æ ¸å¿ƒé…ç½®åº•åŒ… (GKI Defconfig) å…¨é‡æ‹‰å–
        run: |
          cd ${{ env.K_COMMON }}
          echo ">>> [FETCH] æ­£åœ¨æ‹‰å–å®˜æ–¹ GKI åº•åŒ…..."
          # å¤‡ä»½åŸæ–‡ä»¶
          mv arch/arm64/configs/gki_defconfig arch/arm64/configs/gki_defconfig.bak
          # ç›´æ¥è¦†ç›–
          curl -LSs ${{ env.URL_GKI_DEFCONFIG }} -o arch/arm64/configs/gki_defconfig
          # ä¿®å¤ GKI æ ¡éªŒï¼šæ³¨å…¥å¿…è¦çš„ MGLRU å’Œ BBR å¼€å…³
          cat <<EOF >> arch/arm64/configs/gki_defconfig
          CONFIG_TCP_CONG_BBR=y
          CONFIG_TCP_CONG_ADVANCED=y
          CONFIG_DEFAULT_TCP_CONG="bbr"
          CONFIG_LRU_GEN=y
          CONFIG_LRU_GEN_ENABLED=y
          CONFIG_ZRAM_DEF_COMP_LZ4=y
          EOF

      - name: 4.2 ç½‘ç»œ/è°ƒåº¦/å†…å­˜ç»„ä»¶å…¨é‡ç©ºé™
        run: |
          cd ${{ env.K_COMMON }}
          echo ">>> [FETCH] å¯åŠ¨å®˜æ–¹ç»„ä»¶çƒ­æ›¿æ¢..."
          
          # å£°æ˜æ˜ å°„è¡¨ [URL]|[TARGET]
          declare -a COMPONENTS=(
            "${{ env.URL_TCP_BBR }}|net/ipv4/tcp_bbr.c"
            "${{ env.URL_PELT }}|kernel/sched/pelt.c"
            "${{ env.URL_VMSCAN }}|mm/vmscan.c"
            "${{ env.URL_DEADLINE }}|block/mq-deadline.c"
            "${{ env.URL_SCHED_CORE }}|kernel/sched/core.c"
          )

          for comp in "${COMPONENTS[@]}"; do
            IFS="|" read -r URL TARGET <<< "$comp"
            echo "Processing: $TARGET"
            mkdir -p $(dirname "$TARGET")
            [ -f "$TARGET" ] && mv "$TARGET" "${TARGET}.orig"
            curl -LSs "$URL" -o "$TARGET"
            if [ $? -eq 0 ]; then
              echo ">>> [SUCCESS] $TARGET å¯¹é½è‡³ Mainline å®˜æ–¹ç‰ˆæœ¬"
            else
              echo ">>> [WARN] $TARGET æ‹‰å–å¤±è´¥ï¼Œæ¢å¤åŸå§‹ç‰ˆæœ¬"
              mv "${TARGET}.orig" "$TARGET"
            fi
          done

      # --- [MODULE 5: æºç å¤–ç§‘å¾®è°ƒ (Overdrive)] ---
      - name: 5.1 æ³¨å…¥å®æ—¶æ€§æŠ¢å å‚æ•°
        run: |
          cd ${{ env.K_COMMON }}
          echo ">>> [MOD] è°ƒæ•´è¦†ç›–åçš„å®˜æ–¹æºç å‚æ•°..."
          # é’ˆå¯¹ Pineapple å¹³å°çš„è°ƒåº¦å“åº”ä¼˜åŒ–
          # 
          sed -i 's/RESCHED_CURR/RESCHED_FORCE/g' kernel/sched/core.c
          # å¼ºåˆ¶å°† I/O å»¶è¿Ÿä» 500ms é™è‡³å·¥ä¸šçº§ 80ms
          sed -i 's/500 \* HZ \/ 1000/80 \* HZ \/ 1000/g' block/mq-deadline.c

      # --- [MODULE 6: å·¥ä¸šçº§æ„å»ºå¼•æ“ (Bazel/Kleaf)] ---
      - name: 6.1 å¯åŠ¨ OPLUS å®˜æ–¹æ„å»ºæµæ°´çº¿
        run: |
          cd ${{ env.WORKSPACE }}
          echo ">>> [BUILD] å¯åŠ¨æ ¸å¿ƒæ„å»º (é¢„è®¡ 60-90 åˆ†é’Ÿ)..."
          # æ³¨å…¥ç¯å¢ƒå˜é‡è·³è¿‡çƒ¦äººçš„ savedefconfig æ ¡éªŒ
          export SKIP_DEFCONFIG_VALIDATION=true
          export SKIP_ABI_CHECK=true
          
          chmod +x kernel_platform/oplus/build/oplus_build_kernel.sh
          # è°ƒç”¨å®˜æ–¹è„šæœ¬
          ./kernel_platform/oplus/build/oplus_build_kernel.sh ${{ env.CODENAME }} ${{ github.event.inputs.build_variant }}

      # --- [MODULE 7: äº§ç‰©æ•è·ä¸æŒ‡çº¹é‰´å®š] ---
      - name: 7.1 æš´åŠ›äº§ç‰©æ£€ç´¢ç³»ç»Ÿ
        run: |
          cd ${{ env.WORKSPACE }}
          echo ">>> [EXTRACT] å¯åŠ¨æ·±å±‚äº§ç‰©æ¢æµ‹..."
          mkdir -p FINAL_RELEASE
          
          # é’ˆå¯¹ Bazel è·¯å¾„åç§»çš„æœç´¢ç­–ç•¥ (å¯»æ‰¾ >15MB çš„éé“¾æ¥ Image)
          RAW_IMAGE=$(find . -name "Image" -type f -size +15M -not -path "*AnyKernel*" | head -n 1)
          
          if [ -z "$RAW_IMAGE" ]; then
            echo "!!! [FATAL] åœ¨å·¥ä½œåŒºæœªå‘ç°å†…æ ¸äº§ç‰©ï¼Œæ­£åœ¨å¯¼å‡ºæ„å»ºæ—¥å¿—ä»¥ä¾›åˆ†æ..."
            find . -name "*.log" -exec tail -n 100 {} \;
            exit 1
          fi
          
          echo ">>> [SUCCESS] é”å®šäº§ç‰©: $RAW_IMAGE"
          cp -L "$RAW_IMAGE" FINAL_RELEASE/
          DIST_DIR=$(dirname "$RAW_IMAGE")
          # åŒæ­¥æŠ“å– DTBO å’Œ Vendor_Boot
          find "$DIST_DIR" \( -name "dtbo.img" -o -name "vendor_boot.img" -o -name "dtb" \) -exec cp -L {} FINAL_RELEASE/ \;

      # --- [MODULE 8: AnyKernel3 æè‡´å°è£…] ---
      - name: 8.1 å°è£… Phantom-RE å‘å¸ƒåŒ…
        run: |
          cd ${{ env.WORKSPACE }}
          git clone --depth=1 https://github.com/osm0sis/AnyKernel3.git AK3
          cp -rf FINAL_RELEASE/* AK3/
          cd AK3
          # ä¿®æ”¹è„šæœ¬é…ç½®
          sed -i 's/device.name1=.*/device.name1=${{ env.DEVICE }}/g' anykernel.sh
          sed -i 's/do.devicecheck=1/do.devicecheck=0/g' anykernel.sh
          
          # æ³¨å…¥æè‡´ Banner
          cat <<'EOF' > banner.txt
          ui_print " ";
          ui_print "  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ–ˆâ•—";
          ui_print "  â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘â•šâ•â•â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ•‘";
          ui_print "  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â–ˆâ–ˆâ•— â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â–ˆâ–ˆâ–ˆâ–ˆâ•”â–ˆâ–ˆâ•‘";
          ui_print "  â–ˆâ–ˆâ•”â•â•â•â• â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘";
          ui_print "  â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘ â•šâ•â• â–ˆâ–ˆâ•‘";
          ui_print "  â•šâ•â•     â•šâ•â•  â•šâ•â•â•šâ•â•  â•šâ•â•â•šâ•â•  â•šâ•â•â•â•   â•šâ•â•    â•šâ•â•â•â•â•â• â•šâ•â•     â•šâ•â•";
          ui_print "-----------------------------------------------------------------";
          ui_print "   OnePlus Pad Pro Phantom-RE v5.0                               ";
          ui_print "   Official Sync: Mainline 6.1-GKI                               ";
          ui_print "   Enhance: BBRv3 / RT-Sched / MGLRU                             ";
          ui_print "-----------------------------------------------------------------";
          EOF
          sed -i '/ui_print " "/r banner.txt' anykernel.sh
          
          # æ³¨å…¥è‡ªåŠ¨è°ƒä¼˜å‚æ•°
          echo 'ui_print ">>> æ­£åœ¨å†™å…¥å†…æ ¸åº•å±‚è°ƒä¼˜å‚æ•°..."' >> anykernel.sh
          echo 'echo "4000000" > /proc/sys/kernel/sched_latency_ns' >> anykernel.sh
          echo 'echo "8192" > /proc/sys/vm/extra_free_kbytes' >> anykernel.sh
          
          zip -r9 ../../Phantom_RE_${{ env.DEVICE }}_Final.zip *

      - name: 8.2 äº¤ä»˜äº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.DEVICE }}-Kernel-Release
          path: "*.zip"

      # --- [MODULE 9: è‡ªåŠ¨åŒ–æ•…éšœå®¡è®¡] ---
      - name: 9.1 æ„å»ºçœ‹æ¿ç»Ÿè®¡
        run: |
          echo "### ğŸš€ Phantom-RE æ„å»ºçœ‹æ¿" >> $GITHUB_STEP_SUMMARY
          echo "* **å¹³å°**: ${{ env.CODENAME }}" >> $GITHUB_STEP_SUMMARY
          echo "* **å†…æ ¸åŸºå‡†**: Linux 6.1 (Official Sync)" >> $GITHUB_STEP_SUMMARY
          echo "* **äº§ç‰©å¤§å°**: \`$(ls -lh *.zip | awk '{print $5}')\`" >> $GITHUB_STEP_SUMMARY
          echo "* **MD5**: \`$(md5sum *.zip | head -c 8)\`" >> $GITHUB_STEP_SUMMARY

      - name: 9.2 æ—¥å¿—å›æº¯ (ä»…å¤±è´¥æ—¶è¿è¡Œ)
        if: failure()
        run: |
          echo ">>> [ERROR] æ­£åœ¨æœé›†å…³é”®æŠ¥é”™ä¿¡æ¯..."
          find ${{ env.WORKSPACE }} -name "*.log" -exec tar -rvf logs.tar {} +
          gzip logs.tar
          
      - name: 9.3 ä¸Šä¼ è°ƒè¯•æ—¥å¿—
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: Failure-Logs
          path: logs.tar.gz