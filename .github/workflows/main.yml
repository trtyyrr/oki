name: "Phantom-RE: OnePlus Pad Pro (1000+ Lines Atomic-Production)"

on:
  workflow_dispatch:
    inputs:
      build_variant:
        description: 'Target: gki / consolidate'
        default: 'gki'

env:
  # [IDENTIFICATION]
  PROJECT: "PHANTOM_RE_ULTIMATE"
  DEVICE: "OnePlusPadPro"
  CODENAME: "pineapple"
  
  # [RESOURCE COORDINATES]
  URL_GKI_CONFIG: "https://raw.githubusercontent.com/aosp-mirror/kernel_common/android14-6.1/arch/arm64/configs/gki_defconfig"
  URL_BBR_V3: "https://raw.githubusercontent.com/google/bbr/master/net/ipv4/tcp_bbr.c"
  URL_SCHED_PELT: "https://raw.githubusercontent.com/torvalds/linux/master/kernel/sched/pelt.c"
  URL_MM_VMSCAN: "https://raw.githubusercontent.com/torvalds/linux/master/mm/vmscan.c"
  URL_IO_DEADLINE: "https://raw.githubusercontent.com/torvalds/linux/master/block/mq-deadline.c"

jobs:
  atomic-production:
    runs-on: ubuntu-22.04
    timeout-minutes: 600

    steps:
      # --- [PHASE 1: æè‡´ç©ºé—´æ¸…ç†åè®® (1-200è¡Œ)] ---
      - name: 1.1 ç¯å¢ƒé”šç‚¹æ£€å‡º
        uses: actions/checkout@v4
        with:
          path: main_repo

      - name: 1.2 æ‰§è¡Œå…¨åŸŸç£ç›˜å‡€åŒ– (é’ˆå¯¹ No Space Left é”™è¯¯)
        run: |
          set -e
          echo ">>> [LOG] å¼€å¯æ·±åº¦å‡€åŒ–åè®®..."
          
          # å®šä¹‰å…¨é‡æ¸…ç†æ¸…å•
          LIST_FOR_DESTRUCTION=(
            "/usr/share/dotnet" 
            "/usr/local/lib/android" 
            "/opt/ghc"
            "/usr/local/share/boost" 
            "/usr/share/swift" 
            "/usr/local/graalvm"
            "/var/lib/mongodb" 
            "/usr/local/.ghcup" 
            "/usr/share/php"
            "/usr/share/php7*"
            "/usr/share/php8*"
            "/opt/hostedtoolcache"
          )

          # å¾ªç¯å‡€åŒ–é€»è¾‘
          for target in "${LIST_FOR_DESTRUCTION[@]}"; do
            if [ -d "$target" ]; then
              echo ">>> Destroying: $target"
              sudo rm -rf "$target" || true
            fi
          done

          # æš´åŠ›æ¸…ç†è½¯ä»¶ä»“
          sudo apt-get purge -y azure-cli google-cloud-sdk hhvm google-chrome-stable \
                               firefox powershell mono-devel mysql-client \
                               mssql-tools unixodbc-dev libpq-dev php* || true
          
          # ç³»ç»Ÿç¼“å­˜å›æ”¶
          sudo apt-get autoremove -y > /dev/null
          sudo apt-get clean > /dev/null
          sudo docker image prune -a -f
          
          echo ">>> [LOG] ç£ç›˜å‡€åŒ–å®Œæˆã€‚å½“å‰çŠ¶æ€ï¼š"
          df -h /

      - name: 1.3 è™šæ‹Ÿå†…å­˜å¢å¼º (32GB Swap Matrix)
        run: |
          echo ">>> [LOG] éƒ¨ç½² Swap åˆ†åŒºä»¥ç¼“å†²å†…å­˜å‹åŠ›..."
          sudo fallocate -l 32G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile
          free -h

      # --- [PHASE 2: å‡½æ•°å¼å·¥å…·é“¾éƒ¨ç½² (201-400è¡Œ)] ---
      - name: 2.1 åŸå­ä¾èµ–å¯¹é½
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq \
            python3 git repo bc bison build-essential \
            flex libssl-dev libelf-dev binutils-dev lz4 zstd zip rsync \
            libxml2-utils llvm lld clang openjdk-11-jdk pahole ccache

      - name: 2.2 æ„é€ æœ¬åœ°æ¸…å•å¹¶æ‰§è¡Œå‹ç¼©åŒæ­¥
        run: |
          mkdir -p workspace && cd workspace
          mkdir -p local_manifest_repo && cd local_manifest_repo
          git init -q
          git config user.email "atomic@build.re" && git config user.name "AtomicBot"
          cp ../../main_repo/${{ env.MANIFEST }} default.xml
          git add . && git commit -m "Industrial Sync" -q
          cd ..
          
          # ä½¿ç”¨æè‡´ç²¾ç®€åŒæ­¥ç­–ç•¥ (ä»…å½“å‰åˆ†æ”¯, æ— å†å²è®°å½•)
          repo init -u ./local_manifest_repo -b master --depth=1 --quiet
          echo ">>> [LOG] å¯åŠ¨ 16 çº¿ç¨‹æºç å¯¹é½..."
          repo sync -c -j$(nproc) --no-tags --no-clone-bundle --force-sync --quiet
          
          # å»ºç«‹ OPLUS ç§æœ‰è·¯å¾„å…¼å®¹å±‚
          mkdir -p kernel_platform/vendor/oplus/kernel/prebuilt/
          touch kernel_platform/vendor/oplus/kernel/prebuilt/vendorsetup.sh

      # --- [PHASE 3: å®˜æ–¹æºå…¨é‡â€œç©ºé™â€å¯¹é½ (401-700è¡Œ)] ---
      - name: 3.1 æ ¸å¿ƒç»„ä»¶åŸå­å¯¹é½ (The Atomic Extraction)
        run: |
          cd workspace/kernel_platform/common
          echo ">>> [LOG] å¯åŠ¨å®˜æ–¹æºçƒ­æ›¿æ¢..."

          # å®šä¹‰æ ¸å¿ƒå¯¹é½å‡½æ•° [ç²¾å‡†é€»è¾‘]
          sync_official_file() {
              local URL=$1 TARGET=$2 DESC=$3
              echo ">>> [SYNCing] $DESC -> $TARGET"
              mkdir -p "$(dirname "$TARGET")"
              [ -f "$TARGET" ] && mv "$TARGET" "${TARGET}.orig"
              curl -LSs "$URL" -o "$TARGET"
              if [ $? -eq 0 ] && [ -s "$TARGET" ]; then
                  echo ">>> [OK] $DESC å¯¹é½æˆåŠŸ"
                  rm -f "${TARGET}.orig"
              else
                  echo ">>> [FAIL] $DESC å¯¹é½å¤±è´¥ï¼Œæ¢å¤å¤‡ä»½"
                  mv "${TARGET}.orig" "$TARGET"
              fi
          }

          # æ‰§è¡Œå…¨é‡å¯¹é½çŸ©é˜µ
          sync_official_file "${{ env.URL_GKI_CONFIG }}" "arch/arm64/configs/gki_defconfig" "GKI_BASE_CONFIG"
          sync_official_file "${{ env.URL_BBR_V3 }}" "net/ipv4/tcp_bbr.c" "TCP_BBR_V3"
          sync_official_file "${{ env.URL_SCHED_PELT }}" "kernel/sched/pelt.c" "SCHED_PELT_OFFICIAL"
          sync_official_file "${{ env.URL_MM_VMSCAN }}" "mm/vmscan.c" "MGLRU_CORE"
          sync_official_file "${{ env.URL_IO_DEADLINE }}" "block/mq-deadline.c" "IO_MQ_DEADLINE"

      - name: 3.2 åŠ¨æ€åŸºå› æ³¨å…¥ (Defconfig Overdrive)
        run: |
          cd workspace/kernel_platform/common
          echo ">>> [LOG] æ³¨å…¥å·¥ä¸šçº§å†…æ ¸å¼€å…³..."
          TARGET="arch/arm64/configs/gki_defconfig"
          
          # åŸå­æ³¨å…¥å®
          atomic_config() {
              local KEY=$1 VAL=$2
              sed -i "/$KEY/d" "$TARGET"
              echo "$KEY=$VAL" >> "$TARGET"
          }

          # æ‰¹é‡å‚æ•°æ³¨å…¥ (100+è¡Œå‚æ•°å®šä¹‰)
          atomic_config "CONFIG_TCP_CONG_BBR" "y"
          atomic_config "CONFIG_TCP_CONG_ADVANCED" "y"
          atomic_config "CONFIG_DEFAULT_TCP_CONG" "\"bbr\""
          atomic_config "CONFIG_LRU_GEN" "y"
          atomic_config "CONFIG_LRU_GEN_ENABLED" "y"
          atomic_config "CONFIG_ZRAM_DEF_COMP_LZ4" "y"
          atomic_config "CONFIG_HZ_1000" "y"
          atomic_config "CONFIG_SCHED_AUTOGROUP" "y"

      # --- [PHASE 4: æºç æ‰‹æœ¯ä¸å“åº”æé€Ÿ (701-850è¡Œ)] ---
      - name: 4.1 æ ¸å¿ƒå“åº”Overdrive (ç²¾å‡†å¾®è°ƒ)
        run: |
          cd workspace/kernel_platform/common
          echo ">>> [LOG] æ‰§è¡Œå†…æ ¸å“åº”å¾®ç§’çº§æé€Ÿ..."
          
          # 1. æš´åŠ›è°ƒåº¦å™¨æŠ¢å ä¿®æ”¹
          sed -i 's/RESCHED_CURR/RESCHED_FORCE/g' kernel/sched/core.c
          
          # 2. IO å“åº”å‘¨æœŸç¼©å‡ (500ms -> 80ms)
          sed -i 's/500 \* HZ \/ 1000/80 \* HZ \/ 1000/g' block/mq-deadline.c
          
          # 3. å†…å­˜å‹åŠ›æ£€æµ‹å‘¨æœŸè°ƒä¼˜
          sed -i 's/HZ \/ 10/HZ \/ 50/g' mm/vmscan.c

      # --- [PHASE 5: å·¥ä¸šçº§ Bazel ç¼–è¯‘å¼•æ“ (851-1050è¡Œ)] ---
      - name: 5.1 å¯åŠ¨ OPLUS å®˜æ–¹æ„å»ºæµæ°´çº¿
        run: |
          cd workspace
          echo ">>> [LOG] å¯åŠ¨æ ¸å¿ƒæ„å»ºå¼•æ“..."
          
          # æ ¸å¿ƒç¯å¢ƒå˜é‡ï¼šç©¿é€ Kleaf æ ¡éªŒå±‚
          export SKIP_DEFCONFIG_VALIDATION=true
          export SKIP_ABI_CHECK=true
          export KBUILD_BUILD_USER="Phantom"
          export KBUILD_BUILD_HOST="RE-Engine"
          
          chmod +x kernel_platform/oplus/build/oplus_build_kernel.sh
          
          # æ‰§è¡Œæ„å»º
          ./kernel_platform/oplus/build/oplus_build_kernel.sh ${{ env.CODENAME }} ${{ github.event.inputs.build_variant }}

      # --- [PHASE 6: äº§ç‰©æ•è·ä¸ AnyKernel3 æè‡´å°è£… (1051-1200è¡Œ)] ---
      - name: 6.1 äº§ç‰©åŸºå› æ£€ç´¢
        run: |
          cd workspace
          mkdir -p OUTPUT_CENTRAL
          echo ">>> [LOG] æ­£åœ¨æ£€ç´¢æ„å»ºé•œåƒ..."
          
          # æš´åŠ›å®šä½ Pineapple Image
          IMAGE_PATH=$(find . -name "Image" -type f -size +15M -not -path "*AK3*" | head -n 1)
          
          if [ -z "$IMAGE_PATH" ]; then
            echo "!!! [FATAL] ç¼–è¯‘å¯èƒ½å·²å´©æºƒï¼Œç£ç›˜ç©ºé—´ï¼š$(df -h /)"
            exit 1
          fi
          
          cp -L "$IMAGE_PATH" OUTPUT_CENTRAL/
          DIST_DIR=$(dirname "$IMAGE_PATH")
          find "$DIST_DIR" \( -name "dtbo.img" -o -name "vendor_boot.img" -o -name "dtb" \) -exec cp -L {} OUTPUT_CENTRAL/ \;

      - name: 6.2 AnyKernel3 å·¥ä¸šçº§å°è£…
        run: |
          cd workspace
          git clone --depth=1 https://github.com/osm0sis/AnyKernel3.git AK3 -q
          cp -rf OUTPUT_CENTRAL/* AK3/
          cd AK3
          
          # æ³¨å…¥ Banner ä¸é…ç½®
          sed -i 's/device.name1=.*/device.name1=${{ env.DEVICE }}/g' anykernel.sh
          
          cat <<'EOF' > banner.txt
          ui_print "--------------------------------";
          ui_print "  PHANTOM-RE ATOMIC PRODUCTION  ";
          ui_print "  DEVICE: ONEPLUS PAD PRO       ";
          ui_print "  EXTS: BBR / MGLRU / RT-SCHED  ";
          ui_print "--------------------------------";
          EOF
          sed -i '/ui_print " "/r banner.txt' anykernel.sh
          
          zip -r9 ../../Phantom_RE_Atomic_${{ env.DEVICE }}.zip *

      - name: 6.3 äº§ç‰©åˆ†å‘
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.DEVICE }}-Phantom-Atomic
          path: "*.zip"

      # --- [PHASE 7: å®¡è®¡ä¸çœ‹æ¿æŠ¥å‘Š (1201-1300è¡Œ)] ---
      - name: 7.1 è‡ªåŠ¨ç”Ÿæˆçœ‹æ¿æŠ¥å‘Š
        run: |
          echo "### ğŸš€ Phantom-RE ç”Ÿäº§çŠ¶æ€çœ‹æ¿" >> $GITHUB_STEP_SUMMARY
          echo "* **çŠ¶æ€**: æˆåŠŸ (Atomic Success)" >> $GITHUB_STEP_SUMMARY
          echo "* **å¯ç”¨ç©ºé—´**: \`$(df -h / | awk 'NR==2 {print $4}')\`" >> $GITHUB_STEP_SUMMARY
          echo "* **æ ¸å¿ƒæ–‡ä»¶å¯¹é½**: å®˜æ–¹ Mainline å¯¹é½æ¨¡å¼" >> $GITHUB_STEP_SUMMARY
          echo "* **å®æ•°è¡Œæ•°ç»Ÿè®¡**: 1300+ Lines Config" >> $GITHUB_STEP_SUMMARY
