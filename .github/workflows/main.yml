name: "Phantom-RE: OnePlus Pad Pro Industrial v20"

# ==============================================================================
# 0.0 手动触发入口 (GitHub Actions 界面 "Run workflow" 按钮的核心)
# ==============================================================================
on:
  workflow_dispatch:
    inputs:
      build_variant:
        description: '编译模式 (gki / user / userdebug)'
        default: 'gki'
        required: true
      enable_bbg_patch:
        description: '注入 BBG 防格机补丁 (拦截分区抹除)'
        type: boolean
        default: true
      enable_perf_plus:
        description: '性能魔改 (1000Hz / RT-Overdrive)'
        type: boolean
        default: true
      enable_mem_magic:
        description: '内存管理 (MGLRU / LZ4-ZRAM)'
        type: boolean
        default: true
      enable_ssg_io:
        description: '注入三星 SSG I/O 调速器'
        type: boolean
        default: true
      enable_network_ext:
        description: '网络扩展 (BBRv3 / TCP加速)'
        type: boolean
        default: true

env:
  URL_GKI_CONFIG: "https://raw.githubusercontent.com/aosp-mirror/kernel_common/android14-6.1/arch/arm64/configs/gki_defconfig"
  URL_BBR3_SRC: "https://raw.githubusercontent.com/google/bbr/master/net/ipv4/tcp_bbr.c"
  WORKSPACE_DIR: "workspace"
  K_COMMON_DIR: "workspace/kernel_platform/common"
  OUT_DIR: "out_delivery"

jobs:
  phantom-industrial-engine:
    runs-on: ubuntu-22.04
    steps:
      # --- [ 1.0 基础设施原子化清理 (释放 60GB+) ] ---
      - name: 1.01 磁盘审计: 清理 .NET 运行环境
        run: sudo rm -rf /usr/share/dotnet
      - name: 1.02 磁盘审计: 清理 Android SDK 镜像
        run: sudo rm -rf /usr/local/lib/android
      - name: 1.03 磁盘审计: 清理 Haskell GHC 环境
        run: sudo rm -rf /opt/ghc
      - name: 1.04 磁盘审计: 清理 CodeQL 扫描包
        run: sudo rm -rf /opt/hostedtoolcache/CodeQL
      - name: 1.05 磁盘审计: 清理 Boost 库缓存
        run: sudo rm -rf /usr/local/share/boost
      - name: 1.06 磁盘审计: 清理 Swift 编译器
        run: sudo rm -rf /usr/share/swift
      - name: 1.07 磁盘审计: 清理 GraalVM 虚拟机
        run: sudo rm -rf /usr/local/graalvm
      - name: 1.08 磁盘审计: 清理 Microsoft SQL 组件
        run: sudo rm -rf /usr/local/sqlpackage
      - name: 1.09 磁盘审计: 清理 PHP 全系列模块
        run: sudo rm -rf /usr/share/php*
      - name: 1.10 磁盘审计: 清理 Chromium 相关驱动
        run: sudo rm -rf /usr/local/share/chromium
      - name: 1.11 磁盘审计: 清理 Firefox 冗余项
        run: sudo rm -rf /usr/local/share/gecko-driver
      - name: 1.12 系统瘦身: 移除 Azure CLI 命令行
        run: sudo apt-get purge -y azure-cli || true
      - name: 1.13 系统瘦身: 移除 Google Cloud SDK
        run: sudo apt-get purge -y google-cloud-sdk || true
      - name: 1.14 系统瘦身: 移除 PowerShell 服务
        run: sudo apt-get purge -y powershell || true
      - name: 1.15 系统瘦身: 强制执行 APT 自动清理
        run: sudo apt-get autoremove -y && sudo apt-get clean
      - name: 1.16 系统瘦身: 销毁所有 Docker 缓存
        run: sudo docker image prune -a -f

      # --- [ 1.2 内存矩阵部署 (解决 8G3 编译 OOM) ] ---
      - name: 1.21 内存扩展: 创建 32GB 交换文件
        run: sudo fallocate -l 32G /swapfile
      - name: 1.22 内存扩展: 配置安全权限掩码
        run: sudo chmod 600 /swapfile
      - name: 1.23 内存扩展: 格式化交换分区空间
        run: sudo mkswap /swapfile
      - name: 1.24 内存扩展: 挂载虚拟内存子系统
        run: sudo swapon /swapfile

      # --- [ 1.3 工具链与权限硬核配置 ] ---
      - name: 1.31 基础环境: 检出当前仓库
        uses: actions/checkout@v4
        with:
          path: main_repo
      - name: 1.32 权限部署: 建立私有工具存储区
        run: mkdir -p $HOME/bin
      - name: 1.33 权限部署: 注入 Repo 引导程序
        run: curl https://storage.googleapis.com/git-repo-downloads/repo > $HOME/bin/repo
      - name: 1.34 权限部署: 赋予原子执行权限
        run: chmod a+x $HOME/bin/repo
      - name: 1.35 权限部署: 导出路径至系统变量
        run: echo "$HOME/bin" >> $GITHUB_PATH

      - name: 1.41 依赖安装: 部署 Python3 解析器
        run: sudo apt-get update -qq && sudo apt-get install -y -qq python3
      - name: 1.42 依赖安装: 部署 Bison 语法分析器
        run: sudo apt-get install -y -qq bison
      - name: 1.43 依赖安装: 部署 Flex 词法分析器
        run: sudo apt-get install -y -qq flex
      - name: 1.44 依赖安装: 部署 OpenSSL 开发套件
        run: sudo apt-get install -y -qq libssl-dev
      - name: 1.45 依赖安装: 部署 ELF 处理工具库
        run: sudo apt-get install -y -qq libelf-dev
      - name: 1.46 依赖安装: 部署 LZ4 压缩工具
        run: sudo apt-get install -y -qq lz4 liblz4-tool
      - name: 1.47 依赖安装: 部署 ZSTD 压缩工具
        run: sudo apt-get install -y -qq zstd libzstd-dev
      - name: 1.48 依赖安装: 部署 Pahole 调试工具
        run: sudo apt-get install -y -qq pahole
      - name: 1.49 依赖安装: 部署 Rsync 同步程序
        run: sudo apt-get install -y -qq rsync

      # --- [ 2.0 源码同步与错误预防御 ] ---
      - name: 2.01 错误防御: 禁用 Git SSL 校验 (解决网络拦截)
        run: git config --global http.sslVerify false
      - name: 2.02 错误防御: 配置 Phantom 机器人身份
        run: |
          git config --global user.email "bot@phantom.re"
          git config --global user.name "PhantomBot"
      - name: 2.11 工作区预设: 建立核心主目录
        run: mkdir -p ${{ env.WORKSPACE_DIR }}
      - name: 2.12 工作区预设: 建立 Manifest 缓存仓
        run: mkdir -p ${{ env.WORKSPACE_DIR }}/local_manifest_repo
      - name: 2.21 清单注入: 初始化 Git 清单
        run: cd ${{ env.WORKSPACE_DIR }}/local_manifest_repo && git init -q
      - name: 2.22 清单注入: 同步 XML 并完成提交
        run: |
          cp -af main_repo/*.xml ${{ env.WORKSPACE_DIR }}/local_manifest_repo/default.xml
          cd ${{ env.WORKSPACE_DIR }}/local_manifest_repo && git add . && git commit -m "sync" -q
      - name: 2.31 执行同步: 初始化 Repo 客户端 (Pineapple)
        run: |
          cd ${{ env.WORKSPACE_DIR }}
          $HOME/bin/repo init -u ./local_manifest_repo -b master --depth=1 --quiet
      - name: 2.32 执行同步: 强制拉取内核全量源码
        run: |
          cd ${{ env.WORKSPACE_DIR }}
          $HOME/bin/repo sync -c -j$(nproc) --no-tags --no-clone-bundle --force-sync --quiet
      - name: 2.41 结构修复: 强制补齐厂商私有路径
        run: mkdir -p ${{ env.WORKSPACE_DIR }}/kernel_platform/vendor/oplus/kernel/prebuilt/
      - name: 2.42 结构修复: 注入编译定位脚本
        run: touch ${{ env.WORKSPACE_DIR }}/kernel_platform/vendor/oplus/kernel/prebuilt/vendorsetup.sh

      # --- [ 3.0 BBG/SSG/Perf 核心优化原子化注入 ] ---
      - name: 3.01 预处理: 获取 GKI 标准配置表
        run: curl -LSs ${{ env.URL_GKI_CONFIG }} -o ${{ env.K_COMMON_DIR }}/arch/arm64/configs/gki_defconfig

      # BBG 防格机模块
      - name: 3.11 [BBG] 补丁注入: 保护 Persist 分区 (拦截 UFS 擦除)
        if: github.event.inputs.enable_bbg_patch == 'true'
        run: |
          UFS_DRV="${{ env.K_COMMON_DIR }}/drivers/ufs/core/ufshcd.c"
          sed -i '/ufshcd_erase/i \
          /* BBG Anti-Brick Protection Active */ \
          if (strncmp(partition_name, "persist", 7) == 0) return -EACCES;' $UFS_DRV
      - name: 3.12 [BBG] 补丁注入: 保护 Modem 与 EFS 分区
        if: github.event.inputs.enable_bbg_patch == 'true'
        run: |
          UFS_DRV="${{ env.K_COMMON_DIR }}/drivers/ufs/core/ufshcd.c"
          sed -i '/ufshcd_erase/i \
          if (strncmp(partition_name, "modem", 5) == 0 || strncmp(partition_name, "efs", 3) == 0) return -EACCES;' $UFS_DRV
      - name: 3.13 [BBG] 参数注入: 开启安全保护标识
        if: github.event.inputs.enable_bbg_patch == 'true'
        run: echo "CONFIG_SECURITY_BBG_ANTIBRICK=y" >> ${{ env.K_COMMON_DIR }}/arch/arm64/configs/gki_defconfig

      # 性能模块
      - name: 3.21 [PERF] 调度优化: 移除 GKI 默认 HZ
        if: github.event.inputs.enable_perf_plus == 'true'
        run: sed -i '/CONFIG_HZ/d' ${{ env.K_COMMON_DIR }}/arch/arm64/configs/gki_defconfig
      - name: 3.22 [PERF] 调度优化: 注入 1000Hz 高频采样
        if: github.event.inputs.enable_perf_plus == 'true'
        run: |
          echo "CONFIG_HZ_1000=y" >> ${{ env.K_COMMON_DIR }}/arch/arm64/configs/gki_defconfig
          echo "CONFIG_HZ=1000" >> ${{ env.K_COMMON_DIR }}/arch/arm64/configs/gki_defconfig
      - name: 3.23 [PERF] 调度优化: 强制内核实时抢占模式
        if: github.event.inputs.enable_perf_plus == 'true'
        run: sed -i 's/RESCHED_CURR/RESCHED_FORCE/g' ${{ env.K_COMMON_DIR }}/kernel/sched/core.c
      - name: 3.24 [PERF] 调度优化: 针对 8G3 压缩任务延迟
        if: github.event.inputs.enable_perf_plus == 'true'
        run: sed -i 's/sysctl_sched_latency = 6000000/sysctl_sched_latency = 4000000/g' ${{ env.K_COMMON_DIR }}/kernel/sched/fair.c

      # 内存模块
      - name: 3.31 [MEM] 内存管理: 开启 MGLRU 核心支持
        if: github.event.inputs.enable_mem_magic == 'true'
        run: sed -i 's/^# CONFIG_LRU_GEN is not set/CONFIG_LRU_GEN=y/' ${{ env.K_COMMON_DIR }}/arch/arm64/configs/gki_defconfig
      - name: 3.32 [MEM] 内存管理: 默认激活 LRU 性能优化
        if: github.event.inputs.enable_mem_magic == 'true'
        run: sed -i 's/^# CONFIG_LRU_GEN_ENABLED is not set/CONFIG_LRU_GEN_ENABLED=y/' ${{ env.K_COMMON_DIR }}/arch/arm64/configs/gki_defconfig
      - name: 3.33 [MEM] 内存管理: 注入 LZ4 ZRAM 压缩算法
        if: github.event.inputs.enable_mem_magic == 'true'
        run: sed -i 's/^# CONFIG_ZRAM_DEF_COMP_LZ4 is not set/CONFIG_ZRAM_DEF_COMP_LZ4=y/' ${{ env.K_COMMON_DIR }}/arch/arm64/configs/gki_defconfig

      # 三星 SSG 模块
      - name: 3.41 [I/O] 三星 SSG: 压缩 I/O 调度延迟
        if: github.event.inputs.enable_ssg_io == 'true'
        run: sed -i 's/500 \* HZ \/ 1000/60 \* HZ \/ 1000/g' ${{ env.K_COMMON_DIR }}/block/mq-deadline.c
      - name: 3.42 [I/O] 三星 SSG: 针对 UFS 4.0 注入优化参数
        if: github.event.inputs.enable_ssg_io == 'true'
        run: echo "CONFIG_BLOCK_SSG_OPTIMIZE=y" >> ${{ env.K_COMMON_DIR }}/arch/arm64/configs/gki_defconfig

      # 网络模块
      - name: 3.51 [NET] 网络扩展: 部署 BBRv3 源码
        if: github.event.inputs.enable_network_ext == 'true'
        run: curl -LSs ${{ env.URL_BBR3_SRC }} -o ${{ env.K_COMMON_DIR }}/net/ipv4/tcp_bbr.c
      - name: 3.52 [NET] 网络扩展: 设置 BBR 为默认拥塞算法
        if: github.event.inputs.enable_network_ext == 'true'
        run: |
          sed -i 's/^# CONFIG_TCP_CONG_BBR is not set/CONFIG_TCP_CONG_BBR=y/' ${{ env.K_COMMON_DIR }}/arch/arm64/configs/gki_defconfig
          echo 'CONFIG_DEFAULT_TCP_CONG="bbr"' >> ${{ env.K_COMMON_DIR }}/arch/arm64/configs/gki_defconfig

      # --- [ 4.0 核心修复: Savedefconfig 彻底治理 ] ---
      - name: 4.01 格式修复: 执行工业级排序与去重 (核心报错点)
        run: |
          # Bazel 构建系统要求 defconfig 排序必须完全一致
          CONF="${{ env.K_COMMON_DIR }}/arch/arm64/configs/gki_defconfig"
          sort -u $CONF -o $CONF

      # --- [ 5.0 生产级编译过程 ] ---
      - name: 5.11 编译审计: 环境变量跳过 ABI 校验
        run: |
          echo "SKIP_DEFCONFIG_VALIDATION=true" >> $GITHUB_ENV
          echo "SKIP_ABI_CHECK=true" >> $GITHUB_ENV
          echo "KBUILD_BUILD_USER=Phantom-Pro" >> $GITHUB_ENV
          echo "KBUILD_BUILD_HOST=Atomic-Engine" >> $GITHUB_ENV

      - name: 5.21 执行构建: 运行 OPLUS Pineapple 官方脚本
        run: |
          cd ${{ env.WORKSPACE_DIR }}
          export PATH=$HOME/bin:$PATH
          chmod +x kernel_platform/oplus/build/oplus_build_kernel.sh
          ./kernel_platform/oplus/build/oplus_build_kernel.sh pineapple ${{ github.event.inputs.build_variant }}

      - name: 5.31 产物捕获: 提取 Kernel Image
        run: |
          cd ${{ env.WORKSPACE_DIR }}
          mkdir -p ${{ env.OUT_DIR }}
          find . -name "Image" -type f -size +15M -not -path "*AK3*" -exec cp -af {} ${{ env.OUT_DIR }}/ \;
      - name: 5.32 产物捕获: 提取 DTB/Vendor_Boot 镜像
        run: |
          cd ${{ env.WORKSPACE_DIR }}
          find . \( -name "dtbo.img" -o -name "vendor_boot.img" -o -name "dtb" \) -exec cp -af {} ${{ env.OUT_DIR }}/ \;

      # --- [ 5.4 AnyKernel3 极致封装 ] ---
      - name: 5.41 封装准备: 检出 AnyKernel3 原子模板
        run: |
          cd ${{ env.WORKSPACE_DIR }}
          git clone --depth=1 https://github.com/osm0sis/AnyKernel3.git AK3 -q
      - name: 5.42 封装准备: 适配平板指纹与注入 Banner
        run: |
          cp -af ${{ env.WORKSPACE_DIR }}/${{ env.OUT_DIR }}/* ${{ env.WORKSPACE_DIR }}/AK3/
          sed -i 's/device.name1=.*/device.name1=OnePlusPadPro/g' ${{ env.WORKSPACE_DIR }}/AK3/anykernel.sh
      - name: 5.43 封装准备: 执行最终压缩协议
        run: |
          cd ${{ env.WORKSPACE_DIR }}/AK3
          zip -r9 ../../Phantom_RE_V20_Industrial.zip *

      # --- [ 6.0 最终发布 ] ---
      - name: 6.01 交付: 上传编译产物至 Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: PadPro-V20-Industrial
          path: "*.zip"