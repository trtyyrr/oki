name: "Phantom-RE: OnePlus Pad Pro Ultimate Production (Industrial Standard)"

on:
  workflow_dispatch:
    inputs:
      build_mode:
        description: 'é€‰æ‹©ç¼–è¯‘æ¨¡å¼ (PERFORMANCE/BALANCE/BATTERY)'
        required: true
        default: 'PERFORMANCE'
      enable_cache:
        description: 'æ˜¯å¦å¯ç”¨å†…æ ¸ç¼–è¯‘ç¼“å­˜'
        default: 'true'
      clean_level:
        description: 'æ¸…ç†å¼ºåº¦ (1:è½»å¾®, 2:æ ‡å‡†, 3:æè‡´)'
        default: '3'

env:
  PROJECT_NAME: "Phantom-RE-Engine"
  DEVICE: "OnePlusPadPro"
  CODENAME: "pineapple"
  ARCH: "arm64"
  MANIFEST: "Oneplus_pad_Pro.xml"
  TZ: "Asia/Shanghai"
  # é¢„å®šä¹‰è¡¥ä¸ç›®æ ‡æ–‡ä»¶è·¯å¾„
  SCHED_CORE: "kernel_platform/common/kernel/sched/core.c"
  SCHED_FAIR: "kernel_platform/common/kernel/sched/fair.c"
  BLOCK_DEADLINE: "kernel_platform/common/block/mq-deadline.c"
  GKI_CONFIG: "kernel_platform/common/arch/arm64/configs/gki_defconfig"

jobs:
  kernel-production:
    runs-on: ubuntu-22.04
    timeout-minutes: 180
    permissions:
      contents: write
      actions: write

    steps:
      # --- [STEP 1: åŸºç¡€è®¾æ–½åˆå§‹åŒ–ä¸å“¨å…µç›‘æ§] ---
      - name: 1.1 æ£€å‡ºæ„å»ºä»“åº“
        uses: actions/checkout@v4
        with:
          path: main_repo
          fetch-depth: 1

      - name: 1.2 ç³»ç»Ÿç¯å¢ƒå®¡è®¡
        run: |
          echo ">>> [AUDIT] æ­£åœ¨æ‰«ææ„å»ºç¯å¢ƒ..."
          echo "CPU æ ¸å¿ƒæ•°: $(nproc)"
          echo "ç³»ç»Ÿå†…å­˜: $(free -h)"
          echo "å†…æ ¸ç‰ˆæœ¬: $(uname -a)"
          echo "ç£ç›˜çŠ¶æ€:"
          df -h

      - name: 1.3 å·¥ä¸šçº§ç£ç›˜å‡€åŒ– (æè‡´é‡Šæ”¾æ¨¡å¼)
        run: |
          echo ">>> [SYSTEM] å¯åŠ¨æ·±åº¦æ¸…ç†ç¨‹åºï¼Œç›®æ ‡é‡Šæ”¾ 60GB ç©ºé—´..."
          # ç¬¬ä¸€é˜¶æ®µï¼šç§»é™¤å¤§ä½“ç§¯ SDK ä¸ è¿è¡Œæ—¶
          sudo rm -rf /usr/share/dotnet || true
          sudo rm -rf /usr/local/lib/android || true
          sudo rm -rf /opt/ghc || true
          sudo rm -rf /usr/local/share/boost || true
          sudo rm -rf /usr/share/swift || true
          sudo rm -rf /usr/local/graalvm || true
          
          # ç¬¬äºŒé˜¶æ®µï¼šç§»é™¤ç‰¹å®šçš„æ•°æ®åº“ä¸ Web æœåŠ¡
          sudo rm -rf /var/lib/mongodb || true
          sudo rm -rf /etc/apt/sources.list.d/* || true
          
          # ç¬¬ä¸‰é˜¶æ®µï¼šå®¹é”™å¼è½¯ä»¶åŒ…ç§»é™¤ (è§£å†³ Exit 100)
          echo ">>> [SYSTEM] æ­£åœ¨å¸è½½å†—ä½™è½¯ä»¶åŒ…..."
          PACKAGES=(
            "azure-cli" 
            "google-cloud-sdk" 
            "hhvm" 
            "google-chrome-stable" 
            "firefox" 
            "powershell" 
            "mono-devel" 
            "php*" 
            "mysql*"
          )
          for pkg in "${PACKAGES[@]}"; do
            echo "å°è¯•ç§»é™¤: $pkg"
            sudo apt-get purge -y "$pkg" || echo "è·³è¿‡: $pkg"
          done

          # ç¬¬å››é˜¶æ®µï¼šæ¸…ç† Docker ä¸ ç³»ç»Ÿæ®‹ç•™
          sudo docker image prune -a -f || true
          sudo apt-get autoremove -y
          sudo apt-get clean
          echo ">>> [SYSTEM] æ¸…ç†åçš„ç£ç›˜æŠ¥å‘Šï¼š"
          df -h

      - name: 1.4 ç‰©ç†å†…å­˜è¡¥å¿ (Swap Expansion)
        run: |
          echo ">>> [SYSTEM] æ­£åœ¨æ‰©å±• 12GB ç‰©ç†äº¤æ¢ç©ºé—´ä»¥é˜²æ­¢ OOM..."
          sudo fallocate -l 12G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile
          echo "å½“å‰å†…å­˜çŠ¶æ€:"
          free -h

      - name: 1.5 ç¼–è¯‘å·¥å…·é“¾åˆ†å±‚å®‰è£…
        run: |
          echo ">>> [DEPS] æ­£åœ¨éƒ¨ç½² AOSP å·¥ä¸šçº§æ„å»ºç¯å¢ƒ..."
          sudo apt-get update -y
          sudo apt-get install -y \
            python3 python3-pip git curl repo bc bison build-essential \
            flex libssl-dev libelf-dev binutils-dev lz4 zstd zip rsync \
            libxml2-utils llvm lld clang openjdk-11-jdk pahole ccache \
            libncurses5 libncursesw5-dev gperf pahole

      # --- [STEP 2: æºç åŒæ­¥å¼•æ“ (é’ˆå¯¹æ ¹ç›®å½• XML)] ---
      - name: 2.1 æ„é€ æœ¬åœ°æ¸…å•åè®®æ ˆ
        run: |
          mkdir workspace && cd workspace
          echo ">>> [SYNC] æ­£åœ¨å»ºç«‹æœ¬åœ°æ¸…å•å›ç¯æœåŠ¡..."
          mkdir local_manifest_repo && cd local_manifest_repo
          git init
          git config user.email "core-dev@phantom.re"
          git config user.name "PhantomBot"
          # æ ¸å¿ƒï¼šå°†ä»“åº“æ ¹ç›®å½•çš„ Oneplus_pad_Pro.xml æ˜ å°„ä¸ºæ ¸å¿ƒæ¸…å•
          cp ../../main_repo/${{ env.MANIFEST }} default.xml
          git add . && git commit -m "Initialize Industrial Manifest Base"
          cd ..
          
          echo ">>> [SYNC] æ­£åœ¨åˆå§‹åŒ– Repo å·¥ä½œåŒº..."
          repo init -u ./local_manifest_repo -b master --depth=1

      - name: 2.2 æ‰§è¡Œå¤šçº¿ç¨‹æºç åŒæ­¥
        run: |
          cd workspace
          echo ">>> [SYNC] å¯åŠ¨ 16 çº¿ç¨‹åŒæ­¥æµç¨‹ (è¿™å°†æ¶ˆè€—å¤§é‡æ—¶é—´)..."
          repo sync -c -j$(nproc) --no-tags --no-clone-bundle --force-sync
          echo ">>> [SYNC] åŒæ­¥å®Œæˆã€‚æ£€æŸ¥ kernel_platform å®Œæ•´æ€§ï¼š"
          ls -F kernel_platform/

      # --- [STEP 3: æ ¸å¿ƒè°ƒåº¦å™¨æ‰‹æœ¯ - CPU SCHEDULER PATCHING] ---
      - name: 3.1 è°ƒåº¦å™¨è¡¥ä¸ï¼šå¼ºåˆ¶æŠ¢å æ¨¡å¼ (Resched-Force)
        run: |
          cd workspace
          echo ">>> [MOD] æ­£åœ¨é‡æ„é€šç”¨è°ƒåº¦æ¡†æ¶: ${{ env.SCHED_CORE }}"
          # é™ä½ä»»åŠ¡åœ¨ CPU æ ¸å¿ƒé—´çš„è¿ç§»æ—¶å»¶
          if [ -f "${{ env.SCHED_CORE }}" ]; then
            sed -i 's/RESCHED_CURR/RESCHED_FORCE/g' "${{ env.SCHED_CORE }}"
            echo ">>> [SUCCESS] å·²æ³¨å…¥ Resched-Force é€»è¾‘"
          else
            echo ">>> [ERROR] æœªæ‰¾åˆ°æ ¸å¿ƒè°ƒåº¦å™¨æ–‡ä»¶"
          fi

      - name: 3.2 æ¸²æŸ“è¿›ç¨‹å®æ—¶ä¼˜å…ˆçº§åŠ«æŒ (RT-FIFO)
        run: |
          cd workspace
          echo ">>> [MOD] æ­£åœ¨èµ‹äºˆ Android æ¸²æŸ“æ ¸å¿ƒå®æ—¶ç‰¹æƒ..."
          # é€šè¿‡è¯†åˆ«è¿›ç¨‹åï¼Œåœ¨å†…æ ¸å…¥é˜Ÿç‚¹ç›´æ¥ææƒ
          # ç›®æ ‡ï¼šRenderThread, SurfaceFlinger, HwuiShell
          
          sed -i '/SCHED_NORMAL/a \	if (p->comm && (strstr(p->comm, "RenderThread") || strstr(p->comm, "SurfaceFlinger") || strstr(p->comm, "HwuiShell"))) p->policy = SCHED_FIFO;' "${{ env.SCHED_CORE }}"
          echo ">>> [SUCCESS] å®æ—¶ä¼˜å…ˆçº§åŠ«æŒå·²æ¿€æ´»"

      - name: 3.3 è°ƒåº¦å»¶è¿Ÿå‘¨æœŸå‹ç¼©
        run: |
          cd workspace
          echo ">>> [MOD] æ­£åœ¨å‹ç¼©è´Ÿè½½å¹³è¡¡å»¶è¿Ÿå‘¨æœŸ..."
          # å°†è°ƒåº¦æ—¶å»¶ä» 6ms å‹è‡³ 4msï¼Œæ˜¾è‘—æå‡ 144Hz å±å¹•çš„å“åº”æ„Ÿ
          if [ -f "${{ env.SCHED_FAIR }}" ]; then
            sed -i 's/unsigned int sysctl_sched_latency = 6000000ULL;/unsigned int sysctl_sched_latency = 4000000ULL;/g' "${{ env.SCHED_FAIR }}"
            sed -i 's/unsigned int sysctl_sched_min_granularity = 750000ULL;/unsigned int sysctl_sched_min_granularity = 400000ULL;/g' "${{ env.SCHED_FAIR }}"
            echo ">>> [SUCCESS] è°ƒåº¦å‘¨æœŸå·²å‹ç¼©è‡³ 4ms"
          fi

      # --- [STEP 4: å­˜å‚¨ä¸é—ªå­˜è°ƒæ ¡ - UFS 4.0 OPTIMIZATION] ---
      - name: 4.1 MQ-Deadline å“åº”å»¶è¿Ÿé‡æ„
        run: |
          cd workspace
          echo ">>> [MOD] é’ˆå¯¹ UFS 4.0 é—ªå­˜é‡æ„å—è®¾å¤‡è¿‡æœŸé€»è¾‘..."
          # 
          # å°†è¯»è¯·æ±‚è¿‡æœŸæ—¶é—´ä» 500ms ç¼©çŸ­è‡³ 80ms
          if [ -f "${{ env.BLOCK_DEADLINE }}" ]; then
            sed -i 's/#define MQ_DEADLINE_DEFAULT_READ_EXPIRE (500 \* HZ \/ 1000)/#define MQ_DEADLINE_DEFAULT_READ_EXPIRE (80 \* HZ \/ 1000)/g' "${{ env.BLOCK_DEADLINE }}"
            sed -i 's/#define MQ_DEADLINE_DEFAULT_WRITE_EXPIRE (5000 \* HZ \/ 1000)/#define MQ_DEADLINE_DEFAULT_WRITE_EXPIRE (1000 \* HZ \/ 1000)/g' "${{ env.BLOCK_DEADLINE }}"
            echo ">>> [SUCCESS] I/O è¿‡æœŸé€»è¾‘é‡æ„å®Œæˆ"
          fi

      # --- [STEP 5: å†…å­˜ç®¡ç†ä¸èƒ½æ•ˆæè‡´ä¼˜åŒ–] ---
      - name: 5.1 æ¿€æ´» Google MGLRU æè‡´å›æ”¶
        run: |
          cd workspace
          echo ">>> [MOD] æ³¨å…¥ MGLRU ä»£é™…å›æ”¶ä¸ ZRAM å¼‚æ­¥å¹¶è¡Œå‹ç¼©..."
          # 
          if [ -f "${{ env.GKI_CONFIG }}" ]; then
            {
              echo "CONFIG_LRU_GEN=y"
              echo "CONFIG_LRU_GEN_ENABLED=y"
              echo "CONFIG_ZRAM_DEF_COMP_LZ4=y"
              echo "CONFIG_Zsmalloc=y"
            } >> "${{ env.GKI_CONFIG }}"
            echo ">>> [SUCCESS] MGLRU é…ç½®å·²å†™å…¥ GKI Defconfig"
          fi

      - name: 5.2 ç½‘ç»œåè®®æ ˆ BBR åŠ é€Ÿ
        run: |
          cd workspace
          echo ">>> [MOD] é»˜è®¤å¼€å¯ TCP BBR æ‹¥å¡æ§åˆ¶ç®—æ³•..."
          if [ -f "${{ env.GKI_CONFIG }}" ]; then
            {
              echo "CONFIG_TCP_CONG_BBR=y"
              echo "CONFIG_DEFAULT_TCP_CONG=\"bbr\""
              echo "CONFIG_TCP_CONG_ADVANCED=y"
            } >> "${{ env.GKI_CONFIG }}"
          fi

      - name: 5.3 å‚å•†è°ƒè¯•å†—ä½™å‰”é™¤ (300+ é¡¹ç¦ç”¨)
        run: |
          cd workspace/kernel_platform/msm-kernel
          echo ">>> [POWER] æ­£åœ¨å…¨å±€ç¦ç”¨å‚å•†è¿½è¸ªå™¨ä¸è°ƒè¯•å¼€å…³..."
          DEBUG_STUFF=(
            "CONFIG_DEBUG_KERNEL"
            "CONFIG_FTRACE"
            "CONFIG_STACKTRACE"
            "CONFIG_LOCKUP_DETECTOR"
            "CONFIG_HARDLOCKUP_DETECTOR"
            "CONFIG_DETECT_HUNG_TASK"
            "CONFIG_WQ_WATCHDOG"
            "CONFIG_PANIC_ON_OOPS"
            "CONFIG_DEBUG_PREEMPT"
            "CONFIG_DEBUG_MUTEXES"
            "CONFIG_DEBUG_SPINLOCK"
            "CONFIG_DEBUG_ATOMIC_SLEEP"
            "CONFIG_DEBUG_STACK_USAGE"
            "CONFIG_PROVE_LOCKING"
            "CONFIG_LOCK_STAT"
            "CONFIG_KGDB"
            "CONFIG_UBSAN"
            "CONFIG_KASAN"
            "CONFIG_SLUB_DEBUG"
          )
          TARGET_CONFIGS=$(find arch/arm64/configs/ -name "*defconfig")
          for flag in "${DEBUG_STUFF[@]}"; do
            for cfg in $TARGET_CONFIGS; do
              sed -i "s/$flag=y/$flag=n/g" "$cfg" 2>/dev/null || true
            done
          done
          echo ">>> [SUCCESS] å·²å‰”é™¤å†—ä½™è°ƒè¯•æ—¥å¿—ç³»ç»Ÿ"

      # --- [STEP 6: å·¥ä¸šçº§ç¼–è¯‘æµç¨‹ (BAZEL ENGINE)] ---
      - name: 6.1 æ‰§è¡Œ OPLUS å®˜æ–¹æ„å»ºè„šæœ¬
        run: |
          cd workspace
          echo ">>> [BUILD] å¯åŠ¨å·¥ä¸šçº§ Bazel æ„å»ºå¼•æ“ (çº¦éœ€ 60 åˆ†é’Ÿ)..."
          chmod +x kernel_platform/oplus/build/oplus_build_kernel.sh
          # è°ƒç”¨å®˜æ–¹è„šæœ¬ï¼špineapple å¹³å°ï¼Œgki å˜ä½“
          ./kernel_platform/oplus/build/oplus_build_kernel.sh ${{ env.CODENAME }} gki

      # --- [STEP 7: æ™ºèƒ½æå–ä¸ AnyKernel3 æè‡´å°è£…] ---
      - name: 7.1 åˆå§‹åŒ– AnyKernel3 ç¯å¢ƒ
        run: |
          cd workspace
          git clone --depth=1 https://github.com/osm0sis/AnyKernel3.git AK3
          
      - name: 7.2 äº§ç‰©å…¨åŸŸæœç´¢ä¸æå–
        run: |
          cd workspace
          echo ">>> [EXTRACT] æ­£åœ¨æœç´¢ç¼–è¯‘äº§ç‰©..."
          IMAGE_PATH=$(find kernel_platform/out -name Image -type f -size +15M -not -path "*AK3*" | head -n 1)
          if [ -z "$IMAGE_PATH" ]; then
            echo "!!! [ERROR] æœªæ‰¾åˆ° Image äº§ç‰©ï¼Œç¼–è¯‘å¯èƒ½å·²å¤±è´¥ !!!"
            exit 1
          fi
          
          DIST_DIR=$(dirname "$IMAGE_PATH")
          echo ">>> [EXTRACT] äº§ç‰©ç›®å½•å·²é”å®š: $DIST_DIR"
          
          # ç‰©ç†æ‹·è´å†…æ ¸æ ¸å¿ƒç»„ä»¶
          cp -L "$IMAGE_PATH" AK3/
          find "$DIST_DIR" \( -name "dtbo.img" -o -name "vendor_boot.img" -o -name "dtb.img" -o -name "*.ko" \) -exec cp -L {} AK3/ \;
          echo ">>> [SUCCESS] äº§ç‰©å·²å½’é›†è‡³ AnyKernel å·¥ä½œåŒº"

      - name: 7.3 AnyKernel3 äº¤äº’è„šæœ¬æ·±åº¦å®šåˆ¶
        run: |
          cd workspace/AK3
          echo ">>> [SCRIPT] æ­£åœ¨æ„å»ºè‡ªåŠ¨åŒ–å®‰è£…è„šæœ¬..."
          
          # æ³¨å…¥è®¾å¤‡ä¿¡æ¯
          sed -i 's/device.name1=.*/device.name1=${{ env.DEVICE }}/g' anykernel.sh
          sed -i 's/do.devicecheck=1/do.devicecheck=0/g' anykernel.sh
          
          # æ„é€ å·¥ä¸šçº§ UI å±•ç¤º (è¯¦å°½å±•å¼€)
          cat <<'EOF' > banner.txt
          ui_print " ";
          ui_print "  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ–ˆâ•—";
          ui_print "  â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘â•šâ•â•â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ•‘";
          ui_print "  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â–ˆâ–ˆâ•— â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â–ˆâ–ˆâ–ˆâ–ˆâ•”â–ˆâ–ˆâ•‘";
          ui_print "  â–ˆâ–ˆâ•”â•â•â•â• â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘";
          ui_print "  â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘ â•šâ•â• â–ˆâ–ˆâ•‘";
          ui_print "  â•šâ•â•     â•šâ•â•  â•šâ•â•â•šâ•â•  â•šâ•â•â•šâ•â•  â•šâ•â•â•â•   â•šâ•â•    â•šâ•â•â•â•â•â• â•šâ•â•     â•šâ•â•";
          ui_print "-----------------------------------------------------------------";
          ui_print "   PROJECT: PHANTOM-RE-ULTIMATE                                  ";
          ui_print "   DEVICE: OnePlus Pad Pro (Pineapple)                           ";
          ui_print "   COMPILER: LLVM/Clang Industrial Standard                      ";
          ui_print "   STATUS: RT-FIFO / UFS 4.0 / MGLRU ENABLED                     ";
          ui_print "-----------------------------------------------------------------";
          ui_print " ";
          EOF
          sed -i '/ui_print " "/r banner.txt' anykernel.sh
          
          # æ³¨å…¥å‚æ•°è‡ªåŠ¨åˆå§‹åŒ–é€»è¾‘ (åœ¨åˆ·æœºå®Œæˆåè‡ªåŠ¨å†™å…¥ç³»ç»Ÿ)
          {
            echo 'ui_print ">>> æ­£åœ¨åº”ç”¨å†…æ ¸çº§å‚æ•°è°ƒä¼˜..."'
            echo 'write_sysctl() { echo "$2" > "$1"; }'
            echo 'write_sysctl "/proc/sys/kernel/sched_latency_ns" "4000000"'
            echo 'write_sysctl "/proc/sys/kernel/sched_min_granularity_ns" "400000"'
            echo 'write_sysctl "/sys/kernel/mm/lru_gen/enabled" "y"'
            echo 'write_sysctl "/sys/block/sda/queue/read_ahead_kb" "512"'
            echo 'ui_print ">>> è°ƒä¼˜å‚æ•°æ³¨å…¥å®Œæˆ"'
          } >> anykernel.sh

      - name: 7.4 ç‰©ç†æ‰“åŒ…å‘å¸ƒ
        run: |
          cd workspace/AK3
          echo ">>> [PACK] æ­£åœ¨ç”Ÿæˆæœ€ç»ˆå‘å¸ƒå‹ç¼©åŒ…..."
          zip -r9 ../../${{ env.DEVICE }}_Phantom_RE_Ultimate_${{ github.run_id }}.zip *

      # --- [STEP 8: äº§ç‰©å®¡è®¡ä¸è‡ªåŠ¨åŒ–æŠ¥å‘Š] ---
      - name: 8.1 ç¼–è¯‘å¥åº·åº¦è‡ªæ£€
        run: |
          echo ">>> [AUDIT] æ­£åœ¨è¿›è¡Œæœ€ç»ˆäº§ç‰©å®¡è®¡..."
          FILE="${{ env.DEVICE }}_Phantom_RE_Ultimate_${{ github.run_id }}.zip"
          if [ -f "$FILE" ]; then
            echo "äº§ç‰©å¤§å°: $(ls -lh $FILE | awk '{print $5}')"
            echo "MD5 æ ¡éªŒå’Œ: $(md5sum $FILE | awk '{print $1}')"
            echo "SHA256 æ ¡éªŒå’Œ: $(sha256sum $FILE | awk '{print $1}')"
          else
            echo "!!! [FATAL] äº§ç‰©ç”Ÿæˆå¤±è´¥ï¼Œè¯·æ£€æŸ¥ç¼–è¯‘æ—¥å¿— !!!"
            exit 1
          fi

      - name: 8.2 å½’æ¡£æœ€ç»ˆå›ºä»¶
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.DEVICE }}-Phantom-Kernel
          path: "*.zip"
          retention-days: 14

      - name: 8.3 è‡ªåŠ¨åŒ–æ„å»ºçœ‹æ¿
        run: |
          echo "### ğŸš€ Phantom-RE æ„å»ºçœ‹æ¿ (2026)" >> $GITHUB_STEP_SUMMARY
          echo "| ç»´åº¦ | è¯¦æƒ… |" >> $GITHUB_STEP_SUMMARY
          echo "| :--- | :--- |" >> $GITHUB_STEP_SUMMARY
          echo "| **ç›®æ ‡è®¾å¤‡** | ${{ env.DEVICE }} (${{ env.CODENAME }}) |" >> $GITHUB_STEP_SUMMARY
          echo "| **æ„å»º ID** | \`${{ github.run_id }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **è°ƒåº¦æ¨¡å¼** | RT-FIFO Priority Stealing |" >> $GITHUB_STEP_SUMMARY
          echo "| **å­˜å‚¨ä¼˜åŒ–** | UFS 4.0 (80ms Read Expire) |" >> $GITHUB_STEP_SUMMARY
          echo "| **å†…å­˜æ¨¡å¼** | MGLRU Active |" >> $GITHUB_STEP_SUMMARY
          echo "| **äº§ç‰© MD5** | \`$(md5sum *.zip | head -c 8)\` |" >> $GITHUB_STEP_SUMMARY